<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ABCMB.spectrum &#8212; ABCMB 0.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=5ecbeea2" />
    <link rel="stylesheet" type="text/css" href="../../_static/basic.css?v=b08954a9" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css?v=27fed22d" />
    <script src="../../_static/documentation_options.js?v=837179f8"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for ABCMB.spectrum</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">jax.numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">jnp</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">equinox</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">eqx</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">jax</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">jax</span><span class="w"> </span><span class="kn">import</span> <span class="n">vmap</span><span class="p">,</span> <span class="n">jit</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">grad</span><span class="p">,</span> <span class="n">lax</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">diffrax</span><span class="w"> </span><span class="kn">import</span> <span class="n">diffeqsolve</span><span class="p">,</span> <span class="n">ODETerm</span><span class="p">,</span> <span class="n">Dopri5</span><span class="p">,</span> <span class="n">Kvaerno3</span><span class="p">,</span> <span class="n">Kvaerno5</span><span class="p">,</span> <span class="n">Tsit5</span><span class="p">,</span> <span class="n">SaveAt</span><span class="p">,</span> <span class="n">PIDController</span><span class="p">,</span> <span class="n">DiscreteTerminatingEvent</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">jax.scipy.interpolate</span><span class="w"> </span><span class="kn">import</span> <span class="n">RegularGridInterpolator</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">functools</span><span class="w"> </span><span class="kn">import</span> <span class="n">partial</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">interpax</span><span class="w"> </span><span class="kn">import</span> <span class="n">CubicSpline</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">.</span><span class="w"> </span><span class="kn">import</span> <span class="n">ABCMBTools</span> <span class="k">as</span> <span class="n">tools</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.</span><span class="w"> </span><span class="kn">import</span> <span class="n">constants</span> <span class="k">as</span> <span class="n">cnst</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="n">file_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span>

<span class="n">config</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="s2">&quot;jax_enable_x64&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

<span class="n">bessel_l_tab</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">file_dir</span><span class="o">+</span><span class="s2">&quot;/bessel_tab/l.txt&quot;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;int&quot;</span><span class="p">))</span>
<span class="n">bessel_x_tab</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">file_dir</span><span class="o">+</span><span class="s2">&quot;/bessel_tab/x.txt&quot;</span><span class="p">))</span>
<span class="n">bessel_stop_tab</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">file_dir</span><span class="o">+</span><span class="s2">&quot;/bessel_tab/jl_stop.txt&quot;</span><span class="p">))</span>

<span class="c1"># 2D arrays of tabulated spherical functions over l and x axes.</span>
<span class="n">bessel_phi0_tab</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">file_dir</span><span class="o">+</span><span class="s2">&quot;/bessel_tab/phi0.txt&quot;</span><span class="p">))</span>
<span class="n">bessel_phi1_tab</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">file_dir</span><span class="o">+</span><span class="s2">&quot;/bessel_tab/phi1.txt&quot;</span><span class="p">))</span>
<span class="n">bessel_phi2_tab</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">file_dir</span><span class="o">+</span><span class="s2">&quot;/bessel_tab/phi2.txt&quot;</span><span class="p">))</span>
<span class="n">bessel_epsilon_tab</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">file_dir</span><span class="o">+</span><span class="s2">&quot;/bessel_tab/epsilon.txt&quot;</span><span class="p">))</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">gpus</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">devices</span><span class="p">(</span><span class="s1">&#39;gpu&#39;</span><span class="p">)</span>
    <span class="n">bessel_l_tab</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">device_put</span><span class="p">(</span>
        <span class="n">bessel_l_tab</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">gpus</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">bessel_x_tab</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">device_put</span><span class="p">(</span>
        <span class="n">bessel_x_tab</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">gpus</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">bessel_stop_tab</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">device_put</span><span class="p">(</span>
        <span class="n">bessel_stop_tab</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">gpus</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">bessel_phi0_tab</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">device_put</span><span class="p">(</span>
        <span class="n">bessel_phi0_tab</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">gpus</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">bessel_phi1_tab</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">device_put</span><span class="p">(</span>
        <span class="n">bessel_phi1_tab</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">gpus</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">bessel_phi2_tab</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">device_put</span><span class="p">(</span>
        <span class="n">bessel_phi2_tab</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">gpus</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">bessel_epsilon_tab</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">device_put</span><span class="p">(</span>
        <span class="n">bessel_epsilon_tab</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">gpus</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="k">except</span><span class="p">:</span> 
    <span class="k">pass</span>


<div class="viewcode-block" id="phi0">
<a class="viewcode-back" href="../../ABCMB.html#ABCMB.spectrum.phi0">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">phi0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute spherical Bessel function φ₀.</span>

<span class="sd">    First integer argument i indicates we are computing this for l = bessel_l_tab[i]</span>
<span class="sd">    float argument x is the argument of the bessel function.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    i : int</span>
<span class="sd">        Index into bessel_l_tab for multipole ℓ</span>
<span class="sd">    x : float</span>
<span class="sd">        Argument of spherical Bessel function</span>

<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">    float</span>
<span class="sd">        φ₀(x) for multipole ℓ = bessel_l_tab[i]</span>

<span class="sd">    Notes:</span>
<span class="sd">    ------</span>
<span class="sd">    1312.2697 Eq. (3.19a)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Annoyingly the following line is not jit safe...</span>
    <span class="c1"># For now I am passing in the idx corresponding to the theoretically desired l.</span>
    <span class="c1">#idx = jnp.where(bessel_l_tab == ell)[0][0].item()</span>
    <span class="k">return</span> <span class="n">tools</span><span class="o">.</span><span class="n">fast_interp</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">bessel_x_tab</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">bessel_x_tab</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">bessel_phi0_tab</span><span class="p">[:,</span> <span class="n">i</span><span class="p">])</span></div>


<div class="viewcode-block" id="phi1">
<a class="viewcode-back" href="../../ABCMB.html#ABCMB.spectrum.phi1">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">phi1</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute spherical Bessel function φ₁.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    i : int</span>
<span class="sd">        Index into bessel_l_tab for multipole ℓ</span>
<span class="sd">    x : float</span>
<span class="sd">        Argument of spherical Bessel function</span>

<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">    float</span>
<span class="sd">        φ₁(x) for multipole ℓ = bessel_l_tab[i]</span>

<span class="sd">    Notes:</span>
<span class="sd">    ------</span>
<span class="sd">    1312.2697 Eq. (3.19a)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#idx = jnp.where(bessel_l_tab == ell)[0][0].item()</span>
    <span class="k">return</span> <span class="n">tools</span><span class="o">.</span><span class="n">fast_interp</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">bessel_x_tab</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">bessel_x_tab</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">bessel_phi1_tab</span><span class="p">[:,</span> <span class="n">i</span><span class="p">])</span></div>


<div class="viewcode-block" id="phi2">
<a class="viewcode-back" href="../../ABCMB.html#ABCMB.spectrum.phi2">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">phi2</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute spherical Bessel function φ₂.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    i : int</span>
<span class="sd">        Index into bessel_l_tab for multipole ℓ</span>
<span class="sd">    x : float</span>
<span class="sd">        Argument of spherical Bessel function</span>

<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">    float</span>
<span class="sd">        φ₂(x) for multipole ℓ = bessel_l_tab[i]</span>

<span class="sd">    Notes:</span>
<span class="sd">    ------</span>
<span class="sd">    1312.2697 Eq. (3.19a)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#idx = jnp.where(bessel_l_tab == ell)[0][0].item()</span>
    <span class="k">return</span> <span class="n">tools</span><span class="o">.</span><span class="n">fast_interp</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">bessel_x_tab</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">bessel_x_tab</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">bessel_phi2_tab</span><span class="p">[:,</span> <span class="n">i</span><span class="p">])</span></div>


<div class="viewcode-block" id="epsilon">
<a class="viewcode-back" href="../../ABCMB.html#ABCMB.spectrum.epsilon">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">epsilon</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute polarization coupling function ε.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    i : int</span>
<span class="sd">        Index into bessel_l_tab for multipole ℓ</span>
<span class="sd">    x : float</span>
<span class="sd">        Argument of coupling function</span>

<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">    float</span>
<span class="sd">        ε(x) for multipole ℓ = bessel_l_tab[i]</span>

<span class="sd">    Notes:</span>
<span class="sd">    ------</span>
<span class="sd">    1312.2697 Eq. (3.19b)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#idx = jnp.where(bessel_l_tab == ell)[0][0].item()</span>
    <span class="k">return</span> <span class="n">tools</span><span class="o">.</span><span class="n">fast_interp</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">bessel_x_tab</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">bessel_x_tab</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">bessel_epsilon_tab</span><span class="p">[:,</span> <span class="n">i</span><span class="p">])</span></div>


<div class="viewcode-block" id="SpectrumSolver">
<a class="viewcode-back" href="../../ABCMB.html#ABCMB.spectrum.SpectrumSolver">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">SpectrumSolver</span><span class="p">(</span><span class="n">eqx</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    CMB angular power spectrum computation.</span>

<span class="sd">    Computes temperature and polarization angular power spectra by</span>
<span class="sd">    integrating transfer functions over wavenumber and time.</span>

<span class="sd">    Methods:</span>
<span class="sd">    --------</span>
<span class="sd">    primordial_spectrum : Compute primordial power spectrum</span>
<span class="sd">    Pk_lin : Compute linear matter power spectrum</span>
<span class="sd">    get_Cl : Compute angular power spectra for multiple ℓ</span>
<span class="sd">    Cl_one_ell : Compute angular power spectrum for single ℓ</span>
<span class="sd">    integrand_T0 : Compute SW+ISW temperature source integrand</span>
<span class="sd">    integrand_T1 : Compute ISW temperature source integrand</span>
<span class="sd">    integrand_T2 : Compute polarization temperature source integrand</span>
<span class="sd">    integrand_E : Compute E-mode polarization source integrand</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">ells</span>         <span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span>
    <span class="n">ells_indices</span> <span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span>
    <span class="n">lensing</span> <span class="p">:</span> <span class="nb">bool</span>

    <span class="n">k_pivot</span>    <span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.05</span> <span class="c1"># In 1/Mpc</span>
    <span class="n">switch_sw</span>  <span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.</span>
    <span class="n">switch_isw</span> <span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.</span>
    <span class="n">switch_dop</span> <span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.</span>
    <span class="n">switch_pol</span> <span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">ellmin</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                 <span class="n">ellmax</span><span class="o">=</span><span class="mi">2500</span><span class="p">,</span>
                 <span class="n">lensing</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                 <span class="n">k_pivot</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span>
                 <span class="n">switch_sw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                 <span class="n">switch_isw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                 <span class="n">switch_dop</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                 <span class="n">switch_pol</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ells</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ellmin</span><span class="p">,</span> <span class="n">ellmax</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">ell_idx_min</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">bessel_l_tab</span><span class="o">&lt;=</span><span class="n">ellmin</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">ell_idx_max</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">bessel_l_tab</span><span class="o">&gt;=</span><span class="n">ellmax</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ells_indices</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ell_idx_min</span><span class="p">,</span> <span class="n">ell_idx_max</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">lensing</span> <span class="o">=</span> <span class="n">lensing</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">k_pivot</span>    <span class="o">=</span> <span class="n">k_pivot</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">switch_sw</span>  <span class="o">=</span> <span class="n">switch_sw</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">switch_isw</span> <span class="o">=</span> <span class="n">switch_isw</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">switch_dop</span> <span class="o">=</span> <span class="n">switch_dop</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">switch_pol</span> <span class="o">=</span> <span class="n">switch_pol</span>

<div class="viewcode-block" id="SpectrumSolver.primordial_spectrum">
<a class="viewcode-back" href="../../ABCMB.html#ABCMB.spectrum.SpectrumSolver.primordial_spectrum">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">primordial_spectrum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">BG</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute primordial curvature power spectrum.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        k : float or array</span>
<span class="sd">            Wavenumber (units: Mpc^{-1})</span>
<span class="sd">        BG : cosmology.Background</span>
<span class="sd">            Background cosmology module</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        float or array</span>
<span class="sd">            Primordial power spectrum P_R(k), units Mpc^3</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">BG</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;A_s&#39;</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">k</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">k_pivot</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="n">BG</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;n_s&#39;</span><span class="p">]</span><span class="o">-</span><span class="mf">1.</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">jnp</span><span class="o">.</span><span class="n">pi</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="n">k</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span></div>


<div class="viewcode-block" id="SpectrumSolver.Pk_lin">
<a class="viewcode-back" href="../../ABCMB.html#ABCMB.spectrum.SpectrumSolver.Pk_lin">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">Pk_lin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">PT</span><span class="p">,</span> <span class="n">BG</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute linear matter power spectrum at wavenumbers k and redshift z.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        k : float or array</span>
<span class="sd">            Wavenumber (Mpc^{-1})</span>
<span class="sd">        z : float</span>
<span class="sd">            Redshift to evaluate.</span>
<span class="sd">        PT : perturbations.PerturbationTable</span>
<span class="sd">            Perturbation evolution table</span>
<span class="sd">        BG : cosmology.Background</span>
<span class="sd">            Background cosmology module</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        float or array</span>
<span class="sd">            Linear matter power spectrum P(k, z), units Mpc^3</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">lna</span> <span class="o">=</span> <span class="o">-</span><span class="n">jnp</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="n">z</span><span class="p">)</span>
    
        <span class="c1"># vmapped interpolation over Nk (columns of the 2D arrays)</span>
        <span class="n">interp_over_lna</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">vmap</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">y</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">lna</span><span class="p">,</span> <span class="n">PT</span><span class="o">.</span><span class="n">lna</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span>
            <span class="n">in_axes</span><span class="o">=</span><span class="mi">1</span>  <span class="c1"># loop over columns</span>
        <span class="p">)</span>

        <span class="n">delta_cdm_lna</span> <span class="o">=</span> <span class="n">interp_over_lna</span><span class="p">(</span><span class="n">PT</span><span class="o">.</span><span class="n">delta_cdm</span><span class="p">)</span>  <span class="c1"># shape (Nk,)</span>
        <span class="n">delta_b_lna</span>   <span class="o">=</span> <span class="n">interp_over_lna</span><span class="p">(</span><span class="n">PT</span><span class="o">.</span><span class="n">delta_b</span><span class="p">)</span>    <span class="c1"># shape (Nk,)</span>

        <span class="c1"># now interpolate over k</span>
        <span class="n">delta_cdm</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">PT</span><span class="o">.</span><span class="n">k</span><span class="p">,</span> <span class="n">delta_cdm_lna</span><span class="p">)</span>
        <span class="n">delta_b</span>   <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">PT</span><span class="o">.</span><span class="n">k</span><span class="p">,</span> <span class="n">delta_b_lna</span><span class="p">)</span>

        <span class="c1"># total matter overdensity</span>
        <span class="n">delta_m</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">BG</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;omega_b&#39;</span><span class="p">]</span>   <span class="o">*</span> <span class="n">delta_b</span> <span class="o">+</span>
            <span class="n">BG</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;omega_cdm&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">delta_cdm</span>
        <span class="p">)</span> <span class="o">/</span> <span class="n">BG</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;omega_m&#39;</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">delta_m</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">primordial_spectrum</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">BG</span><span class="p">)</span></div>


<div class="viewcode-block" id="SpectrumSolver.lensing_power_spectrum">
<a class="viewcode-back" href="../../ABCMB.html#ABCMB.spectrum.SpectrumSolver.lensing_power_spectrum">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">lensing_power_spectrum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">lna</span><span class="p">,</span> <span class="n">PT</span><span class="p">,</span> <span class="n">BG</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes the lensing power spectrum at wavenumbers k and redshift z.</span>
<span class="sd">        Eq.(3.15) in astro-ph/0601594</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        k : float or array</span>
<span class="sd">            Wavenumber (Mpc^{-1})</span>
<span class="sd">        lna : float</span>
<span class="sd">            Scale factor</span>
<span class="sd">        PT : perturbations.PerturbationTable</span>
<span class="sd">            Perturbation evolution table</span>
<span class="sd">        BG : cosmology.Background</span>
<span class="sd">            Background cosmology module</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        float or array</span>
<span class="sd">            Lensing matter power spectrum P(k, z), dimensionless.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">lna</span><span class="p">)</span>
        <span class="n">z</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="n">a</span> <span class="o">-</span> <span class="mf">1.</span>
        <span class="n">aH</span> <span class="o">=</span> <span class="n">BG</span><span class="o">.</span><span class="n">aH</span><span class="p">(</span><span class="n">lna</span><span class="p">)</span>

        <span class="n">Omega_m</span> <span class="o">=</span> <span class="n">BG</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;omega_m&quot;</span><span class="p">]</span><span class="o">/</span><span class="n">BG</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;h&quot;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span>
        <span class="n">Omega_L</span> <span class="o">=</span> <span class="n">BG</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;omega_Lambda&quot;</span><span class="p">]</span><span class="o">/</span><span class="n">BG</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;h&quot;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span>

        <span class="c1"># Matter fraction over time after equality. 1 at early times and becomes Om0 today. </span>
        <span class="n">Om</span> <span class="o">=</span> <span class="p">(</span><span class="n">Omega_m</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="n">z</span><span class="p">)</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span><span class="o">/</span> <span class="p">((</span><span class="n">Omega_m</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="n">z</span><span class="p">)</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="n">Omega_L</span><span class="p">)</span>

        <span class="n">Pk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Pk_lin</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">PT</span><span class="p">,</span> <span class="n">BG</span><span class="p">)</span> <span class="c1"># Mpc^3</span>

        <span class="k">return</span> <span class="mf">9.</span><span class="o">/</span><span class="mf">8.</span><span class="o">/</span><span class="n">jnp</span><span class="o">.</span><span class="n">pi</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">Om</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">aH</span><span class="o">**</span><span class="mi">4</span> <span class="o">*</span> <span class="n">Pk</span> <span class="o">/</span> <span class="n">k</span></div>


<div class="viewcode-block" id="SpectrumSolver.lensing_Cl">
<a class="viewcode-back" href="../../ABCMB.html#ABCMB.spectrum.SpectrumSolver.lensing_Cl">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">lensing_Cl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ells</span><span class="p">,</span> <span class="n">PT</span><span class="p">,</span> <span class="n">BG</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Angular lensing power spectrum at multipole ell.</span>

<span class="sd">        IMPORTANT: Assumes Limber approximation throughout, even at ell=2.</span>

<span class="sd">        Eq.(3.14) in astro-ph/0601594, except shifts ell -&gt; ell+1/2 to match CLASS.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        ell : float or array</span>
<span class="sd">            Multipole</span>
<span class="sd">        PT : perturbations.PerturbationTable</span>
<span class="sd">            Perturbation evolution table</span>
<span class="sd">        BG : cosmology.Background</span>
<span class="sd">            Background cosmology module</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        float or array</span>
<span class="sd">            Angular lensing matter power spectrum Cl^phiphi, dimensionless.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">coeff</span> <span class="o">=</span> <span class="mf">8.</span><span class="o">*</span><span class="n">jnp</span><span class="o">.</span><span class="n">pi</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="p">(</span><span class="n">ells</span><span class="o">+</span><span class="mf">0.5</span><span class="p">)</span><span class="o">**</span><span class="mi">3</span>
        <span class="n">chi</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">lna</span> <span class="p">:</span> <span class="n">BG</span><span class="o">.</span><span class="n">tau0</span> <span class="o">-</span> <span class="n">BG</span><span class="o">.</span><span class="n">tau</span><span class="p">(</span><span class="n">lna</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">integrand_func</span><span class="p">(</span><span class="n">lna</span><span class="p">):</span>
            <span class="n">k</span> <span class="o">=</span> <span class="p">(</span><span class="n">ells</span><span class="o">+</span><span class="mf">0.5</span><span class="p">)</span><span class="o">/</span><span class="n">chi</span><span class="p">(</span><span class="n">lna</span><span class="p">)</span>
            <span class="n">window</span> <span class="o">=</span> <span class="p">(</span><span class="n">chi</span><span class="p">(</span><span class="n">BG</span><span class="o">.</span><span class="n">lna_rec</span><span class="p">)</span> <span class="o">-</span> <span class="n">chi</span><span class="p">(</span><span class="n">lna</span><span class="p">))</span><span class="o">/</span><span class="n">chi</span><span class="p">(</span><span class="n">BG</span><span class="o">.</span><span class="n">lna_rec</span><span class="p">)</span><span class="o">/</span><span class="n">chi</span><span class="p">(</span><span class="n">lna</span><span class="p">)</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">chi</span><span class="p">(</span><span class="n">lna</span><span class="p">)</span><span class="o">/</span><span class="n">BG</span><span class="o">.</span><span class="n">aH</span><span class="p">(</span><span class="n">lna</span><span class="p">)</span> <span class="o">*</span> <span class="n">window</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">lensing_power_spectrum</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">lna</span><span class="p">,</span> <span class="n">PT</span><span class="p">,</span> <span class="n">BG</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">res</span>

        <span class="n">lna_axis</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">BG</span><span class="o">.</span><span class="n">lna_rec</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mi">4000</span><span class="p">)</span>
        <span class="n">integrand</span> <span class="o">=</span> <span class="n">vmap</span><span class="p">(</span><span class="n">integrand_func</span><span class="p">)(</span><span class="n">lna_axis</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">coeff</span><span class="o">*</span><span class="n">jnp</span><span class="o">.</span><span class="n">trapezoid</span><span class="p">(</span><span class="n">integrand</span><span class="p">,</span> <span class="n">lna_axis</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></div>


<div class="viewcode-block" id="SpectrumSolver.lensed_Cls">
<a class="viewcode-back" href="../../ABCMB.html#ABCMB.spectrum.SpectrumSolver.lensed_Cls">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">lensed_Cls</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ells</span><span class="p">,</span> <span class="n">ClTT_unlensed</span><span class="p">,</span> <span class="n">ClTE_unlensed</span><span class="p">,</span> <span class="n">ClEE_unlensed</span><span class="p">,</span> <span class="n">PT</span><span class="p">,</span> <span class="n">BG</span><span class="p">):</span>
        <span class="c1">#beta = jnp.linspace(0., jnp.pi/16., 5000)</span>
        <span class="c1">#mu = jnp.cos(beta)</span>
        <span class="n">mu</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">16.</span><span class="p">),</span> <span class="mf">1.</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>

        <span class="c1"># Compute lensing Cl</span>
        <span class="n">Clpp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lensing_Cl</span><span class="p">(</span><span class="n">ells</span><span class="p">,</span> <span class="n">PT</span><span class="p">,</span> <span class="n">BG</span><span class="p">)</span>

        <span class="c1"># Wigner matrices needed in general and for temperature</span>
        <span class="c1"># Note that for all wigner matrices, the symmetry relation is dnm = (-1)^(m-n) x dmn</span>
        <span class="n">d00</span> <span class="o">=</span> <span class="n">tools</span><span class="o">.</span><span class="n">d00</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">ells</span><span class="p">)</span>
        <span class="n">d11</span> <span class="o">=</span> <span class="n">tools</span><span class="o">.</span><span class="n">d1n</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">ells</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">d1m1</span> <span class="o">=</span> <span class="n">tools</span><span class="o">.</span><span class="n">d1n</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">ells</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">d2m2</span> <span class="o">=</span> <span class="n">tools</span><span class="o">.</span><span class="n">d2n</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">ells</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">dm11</span> <span class="o">=</span> <span class="n">d1m1</span>

        <span class="c1"># Wigner matrices needed for polarization</span>
        <span class="n">d22</span> <span class="o">=</span> <span class="n">tools</span><span class="o">.</span><span class="n">d2n</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">ells</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">d31</span> <span class="o">=</span> <span class="n">tools</span><span class="o">.</span><span class="n">d3n</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">ells</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">d40</span> <span class="o">=</span> <span class="n">tools</span><span class="o">.</span><span class="n">d4n</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">ells</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">d3m3</span> <span class="o">=</span> <span class="n">tools</span><span class="o">.</span><span class="n">d3n</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">ells</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">d4m4</span> <span class="o">=</span> <span class="n">tools</span><span class="o">.</span><span class="n">d4n</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">ells</span><span class="p">,</span> <span class="o">-</span><span class="mi">4</span><span class="p">)</span>
        <span class="n">d20</span> <span class="o">=</span> <span class="n">tools</span><span class="o">.</span><span class="n">d2n</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">ells</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">d3m1</span> <span class="o">=</span> <span class="n">tools</span><span class="o">.</span><span class="n">d3n</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">ells</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">d4m2</span> <span class="o">=</span> <span class="n">tools</span><span class="o">.</span><span class="n">d4n</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">ells</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">d02</span> <span class="o">=</span> <span class="n">d20</span>
        <span class="n">dm24</span> <span class="o">=</span> <span class="n">d4m2</span>

        <span class="c1"># Lensing angular correlation function</span>
        <span class="n">Cgl</span>  <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="mf">4.</span><span class="o">/</span><span class="n">jnp</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
            <span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">ells</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">ells</span><span class="o">*</span><span class="p">(</span><span class="n">ells</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">Clpp</span><span class="o">*</span><span class="n">d11</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
        <span class="p">)</span> <span class="c1"># Nmu</span>
        <span class="n">Cgl2</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="mf">4.</span><span class="o">/</span><span class="n">jnp</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
            <span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">ells</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">ells</span><span class="o">*</span><span class="p">(</span><span class="n">ells</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">Clpp</span><span class="o">*</span><span class="n">dm11</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
        <span class="p">)</span> <span class="c1"># Nmu</span>
        <span class="c1">#sigma2     = Cgl[0] - Cgl</span>
        <span class="n">sigma2</span>     <span class="o">=</span> <span class="n">Cgl</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">Cgl</span>
        <span class="n">Cgl</span>    <span class="o">=</span> <span class="n">Cgl</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
        <span class="n">Cgl2</span>   <span class="o">=</span> <span class="n">Cgl2</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
        <span class="n">sigma2</span> <span class="o">=</span> <span class="n">sigma2</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>

        <span class="n">llp1</span>   <span class="o">=</span> <span class="n">ells</span><span class="o">*</span><span class="p">(</span><span class="n">ells</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">X000</span>       <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">llp1</span><span class="o">*</span><span class="n">sigma2</span><span class="o">/</span><span class="mi">4</span><span class="p">)</span>
        <span class="n">X000_prime</span> <span class="o">=</span> <span class="o">-</span><span class="n">llp1</span><span class="o">/</span><span class="mf">4.</span><span class="o">*</span><span class="n">X000</span>
        <span class="n">X220</span>       <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="mf">4.</span><span class="o">*</span><span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">ells</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">ells</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">ells</span><span class="o">*</span><span class="p">(</span><span class="n">ells</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span><span class="o">*</span><span class="n">jnp</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">llp1</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">sigma2</span><span class="o">/</span><span class="mf">4.</span><span class="p">)</span>
        <span class="n">X022</span>       <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">llp1</span><span class="o">-</span><span class="mi">4</span><span class="p">)</span><span class="o">*</span><span class="n">sigma2</span><span class="o">/</span><span class="mi">4</span><span class="p">)</span>
        <span class="n">X022_prime</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">llp1</span><span class="o">-</span><span class="mi">4</span><span class="p">)</span><span class="o">/</span><span class="mi">4</span><span class="o">*</span><span class="n">X022</span>
        <span class="n">X121</span>       <span class="o">=</span> <span class="o">-</span><span class="mf">1.</span><span class="o">/</span><span class="mf">2.</span><span class="o">*</span><span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">ells</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">ells</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">*</span><span class="n">jnp</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">llp1</span><span class="o">-</span><span class="mf">8.</span><span class="o">/</span><span class="mf">3.</span><span class="p">)</span><span class="o">*</span><span class="n">sigma2</span><span class="o">/</span><span class="mf">4.</span><span class="p">)</span>
        <span class="n">X132</span>       <span class="o">=</span> <span class="o">-</span><span class="mf">1.</span><span class="o">/</span><span class="mf">2.</span><span class="o">*</span><span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">ells</span><span class="o">+</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">ells</span><span class="o">-</span><span class="mi">2</span><span class="p">))</span><span class="o">*</span><span class="n">jnp</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">llp1</span><span class="o">-</span><span class="mf">20.</span><span class="o">/</span><span class="mf">3.</span><span class="p">)</span><span class="o">*</span><span class="n">sigma2</span><span class="o">/</span><span class="mf">4.</span><span class="p">)</span>
        <span class="n">X242</span>       <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="mf">4.</span><span class="o">*</span><span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">ells</span><span class="o">+</span><span class="mi">4</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">ells</span><span class="o">+</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">ells</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">ells</span><span class="o">-</span><span class="mi">3</span><span class="p">))</span><span class="o">*</span><span class="n">jnp</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">llp1</span><span class="o">-</span><span class="mf">10.</span><span class="p">)</span><span class="o">*</span><span class="n">sigma2</span><span class="o">/</span><span class="mf">4.</span><span class="p">)</span>

        <span class="c1"># Correlation functions</span>
        <span class="n">ksi</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="mf">4.</span><span class="o">/</span><span class="n">jnp</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
            <span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">ells</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">ClTT_unlensed</span> <span class="o">*</span> <span class="p">(</span>
                <span class="n">X000</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">d00</span> \
                <span class="o">+</span> <span class="mf">8.</span><span class="o">/</span><span class="n">ells</span><span class="o">/</span><span class="p">(</span><span class="n">ells</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">Cgl2</span><span class="o">*</span><span class="n">X000_prime</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">d1m1</span> \
                <span class="o">+</span> <span class="n">Cgl2</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">X000_prime</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">d00</span> <span class="o">+</span> <span class="n">X220</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">d2m2</span><span class="p">)</span> \
                <span class="o">-</span> <span class="n">d00</span>
            <span class="p">),</span> 
            <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
        <span class="p">)</span>

        <span class="n">ksip</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="mf">4.</span><span class="o">/</span><span class="n">jnp</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
            <span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">ells</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">ClEE_unlensed</span> <span class="o">*</span> <span class="p">(</span>
                <span class="n">X022</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">d22</span> \
                <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">Cgl2</span><span class="o">*</span><span class="n">X132</span><span class="o">*</span><span class="n">X121</span><span class="o">*</span><span class="n">d31</span> \
                <span class="o">+</span> <span class="n">Cgl2</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">X022_prime</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">d22</span> <span class="o">+</span> <span class="n">X242</span><span class="o">*</span><span class="n">X220</span><span class="o">*</span><span class="n">d40</span><span class="p">)</span> \
                <span class="o">-</span> <span class="n">d22</span>
            <span class="p">),</span> 
            <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
        <span class="p">)</span>

        <span class="n">ksim</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="mf">4.</span><span class="o">/</span><span class="n">jnp</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
            <span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">ells</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">ClEE_unlensed</span> <span class="o">*</span> <span class="p">(</span>
                <span class="n">X022</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">d2m2</span> \
                <span class="o">+</span> <span class="n">Cgl2</span><span class="o">*</span><span class="p">(</span><span class="n">X121</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">d1m1</span> <span class="o">+</span> <span class="n">X132</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">d3m3</span><span class="p">)</span> \
                <span class="o">+</span> <span class="mf">1.</span><span class="o">/</span><span class="mf">2.</span><span class="o">*</span><span class="n">Cgl2</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">X022_prime</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">d2m2</span> <span class="o">+</span> <span class="n">X220</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">d00</span> <span class="o">+</span> <span class="n">X242</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">d4m4</span><span class="p">)</span> \
                <span class="o">-</span> <span class="n">d2m2</span>
            <span class="p">),</span> 
            <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
        <span class="p">)</span>

        <span class="n">ksix</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="mf">4.</span><span class="o">/</span><span class="n">jnp</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
            <span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">ells</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">ClTE_unlensed</span> <span class="o">*</span> <span class="p">(</span>
                <span class="n">X022</span><span class="o">*</span><span class="n">X000</span><span class="o">*</span><span class="n">d02</span> \
                <span class="o">+</span> <span class="n">Cgl2</span> <span class="o">*</span> <span class="mi">2</span><span class="o">*</span><span class="n">X000_prime</span><span class="o">/</span><span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">llp1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">X121</span><span class="o">*</span><span class="n">d11</span> <span class="o">+</span> <span class="n">X132</span><span class="o">*</span><span class="n">d3m1</span><span class="p">)</span> \
                <span class="o">+</span> <span class="mf">1.</span><span class="o">/</span><span class="mf">2.</span><span class="o">*</span><span class="n">Cgl2</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">((</span><span class="mi">2</span><span class="o">*</span><span class="n">X022_prime</span><span class="o">*</span><span class="n">X000_prime</span><span class="o">+</span><span class="n">X220</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">d20</span><span class="o">+</span><span class="n">X220</span><span class="o">*</span><span class="n">X242</span><span class="o">*</span><span class="n">dm24</span><span class="p">)</span> \
                <span class="o">-</span> <span class="n">d02</span>
            <span class="p">),</span> 
            <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
        <span class="p">)</span>
        
        <span class="c1">#ClTT = 2.*jnp.pi * jnp.trapezoid(corTT[:, None]*d00*jnp.sin(beta)[:, None], beta, axis=0) # Integrand becomes (Nmu, Nells), result is Nells</span>
        <span class="n">ClTT</span> <span class="o">=</span> <span class="mf">2.</span><span class="o">*</span><span class="n">jnp</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">trapezoid</span><span class="p">(</span><span class="n">ksi</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span><span class="o">*</span><span class="n">d00</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">ClTT_unlensed</span>
        <span class="n">ClTE</span> <span class="o">=</span> <span class="mf">2.</span><span class="o">*</span><span class="n">jnp</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">trapezoid</span><span class="p">(</span><span class="n">ksix</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span><span class="o">*</span><span class="n">d20</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">ClTE_unlensed</span>
        <span class="n">ClEE</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="mf">2.</span> <span class="o">*</span> <span class="mf">2.</span><span class="o">*</span><span class="n">jnp</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">trapezoid</span><span class="p">(</span><span class="n">ksip</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span><span class="o">*</span><span class="n">d22</span><span class="o">+</span><span class="n">ksim</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span><span class="o">*</span><span class="n">d2m2</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">ClEE_unlensed</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">ClTT</span><span class="p">,</span> <span class="n">ClTE</span><span class="p">,</span> <span class="n">ClEE</span><span class="p">)</span></div>


    <span class="c1"># def get_Cl(self, PT, BG):</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     Compute angular power spectra for multiple multipoles.</span>

    <span class="c1">#     Parameters:</span>
    <span class="c1">#     -----------</span>
    <span class="c1">#     idxs : array</span>
    <span class="c1">#         Indices into bessel_l_tab for desired multipoles</span>
    <span class="c1">#     PT : perturbations.PerturbationTable</span>
    <span class="c1">#         Perturbation evolution table</span>
    <span class="c1">#     BG : cosmology.Background</span>
    <span class="c1">#         Background cosmology module</span>

    <span class="c1">#     Returns:</span>
    <span class="c1">#     --------</span>
    <span class="c1">#     array</span>
    <span class="c1">#         Angular power spectra (C_ℓ^TT, C_ℓ^TE, C_ℓ^EE) for each ℓ</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     ells = bessel_l_tab[self.ells_indices]</span>
    <span class="c1">#     Cls_raw = vmap(lambda idx : self.Cl_one_ell(idx, PT, BG))(self.ells_indices)</span>
    <span class="c1">#     return ells, Cls_raw</span>
    <span class="c1">#     # Cubic interpolate onto </span>

    <span class="c1">#     return 0.</span>

<div class="viewcode-block" id="SpectrumSolver.get_Cl">
<a class="viewcode-back" href="../../ABCMB.html#ABCMB.spectrum.SpectrumSolver.get_Cl">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_Cl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">PT</span><span class="p">,</span> <span class="n">BG</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute angular power spectra for multiple multipoles using lax.scan.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">scan_fun</span><span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
            <span class="n">cltt</span><span class="p">,</span> <span class="n">clte</span><span class="p">,</span> <span class="n">clee</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Cl_one_ell</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">PT</span><span class="p">,</span> <span class="n">BG</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">cltt</span><span class="p">,</span> <span class="n">clte</span><span class="p">,</span> <span class="n">clee</span><span class="p">])</span>

        <span class="n">_</span><span class="p">,</span> <span class="n">Cls_raw</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span><span class="n">scan_fun</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ells_indices</span><span class="p">)</span>

        <span class="c1"># Cubic spline for smooth Cl over user requested ells</span>

        <span class="n">tt_raw</span> <span class="o">=</span> <span class="n">Cls_raw</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">te_raw</span> <span class="o">=</span> <span class="n">Cls_raw</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">ee_raw</span> <span class="o">=</span> <span class="n">Cls_raw</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span>

        <span class="n">ells</span> <span class="o">=</span> <span class="n">bessel_l_tab</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ells_indices</span><span class="p">]</span>
        <span class="n">tt_unlensed</span> <span class="o">=</span> <span class="n">CubicSpline</span><span class="p">(</span><span class="n">ells</span><span class="p">,</span> <span class="n">tt_raw</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="kc">False</span><span class="p">)(</span><span class="bp">self</span><span class="o">.</span><span class="n">ells</span><span class="p">)</span>
        <span class="n">te_unlensed</span> <span class="o">=</span> <span class="n">CubicSpline</span><span class="p">(</span><span class="n">ells</span><span class="p">,</span> <span class="n">te_raw</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="kc">False</span><span class="p">)(</span><span class="bp">self</span><span class="o">.</span><span class="n">ells</span><span class="p">)</span>
        <span class="n">ee_unlensed</span> <span class="o">=</span> <span class="n">CubicSpline</span><span class="p">(</span><span class="n">ells</span><span class="p">,</span> <span class="n">ee_raw</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="kc">False</span><span class="p">)(</span><span class="bp">self</span><span class="o">.</span><span class="n">ells</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">get_lensed_Cls</span><span class="p">():</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">lensed_Cls</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ells</span><span class="p">,</span> <span class="n">tt_unlensed</span><span class="p">,</span> <span class="n">te_unlensed</span><span class="p">,</span> <span class="n">ee_unlensed</span><span class="p">,</span> <span class="n">PT</span><span class="p">,</span> <span class="n">BG</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">get_unlensed_Cls</span><span class="p">():</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">tt_unlensed</span><span class="p">,</span> <span class="n">te_unlensed</span><span class="p">,</span> <span class="n">ee_unlensed</span><span class="p">)</span>

        <span class="c1">#return (tt_unlensed, te_unlensed, ee_unlensed)</span>
        <span class="k">return</span> <span class="n">lax</span><span class="o">.</span><span class="n">cond</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lensing</span><span class="p">,</span>
            <span class="n">get_lensed_Cls</span><span class="p">,</span>
            <span class="n">get_unlensed_Cls</span>
        <span class="p">)</span></div>

        <span class="c1">#return get_lensed_Cls()</span>

<div class="viewcode-block" id="SpectrumSolver.get_Cl_vmap">
<a class="viewcode-back" href="../../ABCMB.html#ABCMB.spectrum.SpectrumSolver.get_Cl_vmap">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_Cl_vmap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">PT</span><span class="p">,</span> <span class="n">BG</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute angular power spectra for multiple multipoles using lax.scan.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">tt_raw</span><span class="p">,</span> <span class="n">te_raw</span><span class="p">,</span> <span class="n">ee_raw</span> <span class="o">=</span> <span class="n">vmap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Cl_one_ell</span><span class="p">,</span> <span class="n">in_axes</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">))(</span><span class="bp">self</span><span class="o">.</span><span class="n">ells_indices</span><span class="p">,</span> <span class="n">PT</span><span class="p">,</span> <span class="n">BG</span><span class="p">)</span>

        <span class="n">ells</span> <span class="o">=</span> <span class="n">bessel_l_tab</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ells_indices</span><span class="p">]</span>
        <span class="n">tt_unlensed</span> <span class="o">=</span> <span class="n">CubicSpline</span><span class="p">(</span><span class="n">ells</span><span class="p">,</span> <span class="n">tt_raw</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="kc">False</span><span class="p">)(</span><span class="bp">self</span><span class="o">.</span><span class="n">ells</span><span class="p">)</span>
        <span class="n">te_unlensed</span> <span class="o">=</span> <span class="n">CubicSpline</span><span class="p">(</span><span class="n">ells</span><span class="p">,</span> <span class="n">te_raw</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="kc">False</span><span class="p">)(</span><span class="bp">self</span><span class="o">.</span><span class="n">ells</span><span class="p">)</span>
        <span class="n">ee_unlensed</span> <span class="o">=</span> <span class="n">CubicSpline</span><span class="p">(</span><span class="n">ells</span><span class="p">,</span> <span class="n">ee_raw</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="kc">False</span><span class="p">)(</span><span class="bp">self</span><span class="o">.</span><span class="n">ells</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">get_lensed_Cls</span><span class="p">():</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">lensed_Cls</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ells</span><span class="p">,</span> <span class="n">tt_unlensed</span><span class="p">,</span> <span class="n">te_unlensed</span><span class="p">,</span> <span class="n">ee_unlensed</span><span class="p">,</span> <span class="n">PT</span><span class="p">,</span> <span class="n">BG</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">get_unlensed_Cls</span><span class="p">():</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">tt_unlensed</span><span class="p">,</span> <span class="n">te_unlensed</span><span class="p">,</span> <span class="n">ee_unlensed</span><span class="p">)</span>

        <span class="c1">#return (tt_unlensed, te_unlensed, ee_unlensed)</span>
        <span class="k">return</span> <span class="n">lax</span><span class="o">.</span><span class="n">cond</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lensing</span><span class="p">,</span>
            <span class="n">get_lensed_Cls</span><span class="p">,</span>
            <span class="n">get_unlensed_Cls</span>
        <span class="p">)</span></div>

        <span class="c1">#return get_lensed_Cls()</span>

<div class="viewcode-block" id="SpectrumSolver.Cl_one_ell">
<a class="viewcode-back" href="../../ABCMB.html#ABCMB.spectrum.SpectrumSolver.Cl_one_ell">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">Cl_one_ell</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">PT</span><span class="p">,</span> <span class="n">BG</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute angular power spectrum for single multipole.</span>

<span class="sd">        Integrates transfer functions over wavenumber.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        idx : int</span>
<span class="sd">            Index into bessel_l_tab for multipole ℓ</span>
<span class="sd">        PT : perturbations.PerturbationTable</span>
<span class="sd">            Perturbation evolution table</span>
<span class="sd">        BG : cosmology.Background</span>
<span class="sd">            Background cosmology module</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        tuple</span>
<span class="sd">            (C_ℓ^TT, C_ℓ^TE, C_ℓ^EE) angular power spectra</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Beyond this k point the bessel function vanishes exponentially.</span>
        <span class="n">k_cut_small</span> <span class="o">=</span> <span class="mf">0.95</span><span class="o">*</span><span class="n">bessel_l_tab</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">/</span><span class="n">BG</span><span class="o">.</span><span class="n">rA_rec</span>

        <span class="c1"># The upperbound of the integral is given by the multipole cut approximation in arxiv:1312.2697</span>
        <span class="c1"># For now, the integration axis is chosen to be a logspaced grid, from kmin to kmin+kcut.</span>
        <span class="c1"># This is because for k&gt;kmin, the integrand ~jl^2 which experiences asymptotic damping for larger k&#39;s.</span>
        <span class="c1"># The peak values of the envelope drop by a few orders of magnitude within 3-4 peaks or so, so its</span>
        <span class="c1"># only really important to have high resolution near kmin. </span>
        <span class="n">k_T0_axis</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">geomspace</span><span class="p">(</span><span class="n">k_cut_small</span><span class="p">,</span> <span class="n">k_cut_small</span><span class="o">+</span><span class="mf">0.1</span><span class="p">,</span> <span class="mi">400</span><span class="p">)</span> 
        <span class="n">lna_axis</span> <span class="o">=</span> <span class="n">PT</span><span class="o">.</span><span class="n">lna</span>

        <span class="c1">### TRANSFER FUNCTION ###</span>
        <span class="c1"># Background quantities, all Nlna 1D vectors</span>
        <span class="n">tau0</span> <span class="o">=</span> <span class="n">BG</span><span class="o">.</span><span class="n">tau0</span>
        <span class="n">tau</span> <span class="o">=</span> <span class="n">BG</span><span class="o">.</span><span class="n">tau</span><span class="p">(</span><span class="n">lna_axis</span><span class="p">)</span>
        <span class="n">g</span>   <span class="o">=</span> <span class="n">BG</span><span class="o">.</span><span class="n">visibility</span><span class="p">(</span><span class="n">lna_axis</span><span class="p">)</span>
        <span class="n">g_prime</span> <span class="o">=</span> <span class="n">vmap</span><span class="p">(</span><span class="n">grad</span><span class="p">(</span><span class="n">BG</span><span class="o">.</span><span class="n">visibility</span><span class="p">))(</span><span class="n">lna_axis</span><span class="p">)</span> <span class="c1"># Derivative of g w.r.t. lna</span>
        <span class="n">aH</span>  <span class="o">=</span> <span class="n">BG</span><span class="o">.</span><span class="n">aH</span><span class="p">(</span><span class="n">lna_axis</span><span class="p">)</span>
        <span class="n">kappa</span> <span class="o">=</span> <span class="n">BG</span><span class="o">.</span><span class="n">kappa</span><span class="p">(</span><span class="n">lna_axis</span><span class="p">)</span>
        <span class="n">aH_dot</span> <span class="o">=</span> <span class="n">BG</span><span class="o">.</span><span class="n">aH_prime</span><span class="p">(</span><span class="n">lna_axis</span><span class="p">)</span> <span class="o">*</span> <span class="n">aH</span> <span class="c1"># Derivative of aH w.r.t. conformal time tau.</span>

        <span class="n">g</span>        <span class="o">=</span> <span class="n">g</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
        <span class="n">g_prime</span>  <span class="o">=</span> <span class="n">g_prime</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
        <span class="n">aH</span>       <span class="o">=</span> <span class="n">aH</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
        <span class="n">kappa</span>    <span class="o">=</span> <span class="n">kappa</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
        <span class="n">aH_dot</span>   <span class="o">=</span> <span class="n">aH_dot</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>

        <span class="c1"># Perturbations, all (Nk, Nlna) 2D vectors</span>
        <span class="n">interp_column</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">col</span> <span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">k_T0_axis</span><span class="p">),</span> <span class="n">jnp</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">PT</span><span class="o">.</span><span class="n">k</span><span class="p">),</span> <span class="n">col</span><span class="p">)</span>

        <span class="c1"># Found that this is much much faster than RegularGridInterpolator</span>
        <span class="n">delta_g</span>       <span class="o">=</span> <span class="n">vmap</span><span class="p">(</span><span class="n">interp_column</span><span class="p">,</span> <span class="n">in_axes</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">out_axes</span><span class="o">=</span><span class="mi">0</span><span class="p">)(</span><span class="n">PT</span><span class="o">.</span><span class="n">delta_g</span><span class="p">)</span>
        <span class="n">theta_b</span>       <span class="o">=</span> <span class="n">vmap</span><span class="p">(</span><span class="n">interp_column</span><span class="p">,</span> <span class="n">in_axes</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">out_axes</span><span class="o">=</span><span class="mi">0</span><span class="p">)(</span><span class="n">PT</span><span class="o">.</span><span class="n">theta_b</span><span class="p">)</span>
        <span class="n">theta_b_prime</span> <span class="o">=</span> <span class="n">vmap</span><span class="p">(</span><span class="n">interp_column</span><span class="p">,</span> <span class="n">in_axes</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">out_axes</span><span class="o">=</span><span class="mi">0</span><span class="p">)(</span><span class="n">PT</span><span class="o">.</span><span class="n">theta_b_prime</span><span class="p">)</span>
        <span class="n">sigma_g</span>       <span class="o">=</span> <span class="n">vmap</span><span class="p">(</span><span class="n">interp_column</span><span class="p">,</span> <span class="n">in_axes</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">out_axes</span><span class="o">=</span><span class="mi">0</span><span class="p">)(</span><span class="n">PT</span><span class="o">.</span><span class="n">sigma_g</span><span class="p">)</span>
        <span class="n">Gg0</span>           <span class="o">=</span> <span class="n">vmap</span><span class="p">(</span><span class="n">interp_column</span><span class="p">,</span> <span class="n">in_axes</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">out_axes</span><span class="o">=</span><span class="mi">0</span><span class="p">)(</span><span class="n">PT</span><span class="o">.</span><span class="n">Gg0</span><span class="p">)</span>
        <span class="n">Gg2</span>           <span class="o">=</span> <span class="n">vmap</span><span class="p">(</span><span class="n">interp_column</span><span class="p">,</span> <span class="n">in_axes</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">out_axes</span><span class="o">=</span><span class="mi">0</span><span class="p">)(</span><span class="n">PT</span><span class="o">.</span><span class="n">Gg2</span><span class="p">)</span>
        <span class="n">eta</span>           <span class="o">=</span> <span class="n">vmap</span><span class="p">(</span><span class="n">interp_column</span><span class="p">,</span> <span class="n">in_axes</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">out_axes</span><span class="o">=</span><span class="mi">0</span><span class="p">)(</span><span class="n">PT</span><span class="o">.</span><span class="n">metric_eta</span><span class="p">)</span>
        <span class="n">eta_prime</span>     <span class="o">=</span> <span class="n">vmap</span><span class="p">(</span><span class="n">interp_column</span><span class="p">,</span> <span class="n">in_axes</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">out_axes</span><span class="o">=</span><span class="mi">0</span><span class="p">)(</span><span class="n">PT</span><span class="o">.</span><span class="n">metric_eta_prime</span><span class="p">)</span>
        <span class="n">alpha</span>         <span class="o">=</span> <span class="n">vmap</span><span class="p">(</span><span class="n">interp_column</span><span class="p">,</span> <span class="n">in_axes</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">out_axes</span><span class="o">=</span><span class="mi">0</span><span class="p">)(</span><span class="n">PT</span><span class="o">.</span><span class="n">metric_alpha</span><span class="p">)</span>
        <span class="n">alpha_prime</span>   <span class="o">=</span> <span class="n">vmap</span><span class="p">(</span><span class="n">interp_column</span><span class="p">,</span> <span class="n">in_axes</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">out_axes</span><span class="o">=</span><span class="mi">0</span><span class="p">)(</span><span class="n">PT</span><span class="o">.</span><span class="n">metric_alpha_prime</span><span class="p">)</span>
        
        <span class="c1">#sourceT0 = self.switch_sw * g * (delta_g/4. + aH*alpha_prime) </span>
        <span class="c1">#sourceT0 = 1.</span>

        <span class="c1"># Source terms</span>
        <span class="c1"># TODO: fix ISW term</span>
        <span class="n">sourceT0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">switch_sw</span> <span class="o">*</span> <span class="n">g</span> <span class="o">*</span> <span class="p">(</span><span class="n">delta_g</span><span class="o">/</span><span class="mf">4.</span> <span class="o">+</span> <span class="n">aH</span><span class="o">*</span><span class="n">alpha_prime</span><span class="p">)</span> \
                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">switch_isw</span> <span class="o">*</span> <span class="p">(</span>
                    <span class="n">g</span> <span class="o">*</span> <span class="p">(</span><span class="n">eta</span> <span class="o">-</span> <span class="n">aH</span><span class="o">*</span><span class="n">alpha_prime</span> <span class="o">-</span> <span class="mf">2.</span><span class="o">*</span><span class="n">aH</span><span class="o">*</span><span class="n">alpha</span><span class="p">)</span> \
                    <span class="o">+</span> <span class="mf">2.</span><span class="o">*</span><span class="n">jnp</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">kappa</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">aH</span><span class="o">*</span><span class="n">eta_prime</span> <span class="o">-</span> <span class="n">aH_dot</span><span class="o">*</span><span class="n">alpha</span> <span class="o">-</span> <span class="n">aH</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">alpha_prime</span><span class="p">)</span>
                <span class="p">)</span> \
                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">switch_dop</span> <span class="o">*</span> <span class="p">(</span>
                    <span class="n">aH</span> <span class="o">*</span> <span class="p">(</span><span class="n">g</span><span class="o">*</span><span class="p">((</span><span class="n">theta_b_prime</span> <span class="o">/</span> <span class="n">k_T0_axis</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">alpha_prime</span><span class="p">)</span> \
                    <span class="o">+</span> <span class="n">g_prime</span><span class="o">*</span><span class="p">((</span><span class="n">theta_b</span> <span class="o">/</span> <span class="n">k_T0_axis</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">alpha</span><span class="p">))</span>
                <span class="p">)</span>
        <span class="c1">#sourceT0 = 0.</span>

        <span class="n">sourceT1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">switch_isw</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">kappa</span><span class="p">)</span> <span class="o">*</span> \
                <span class="p">((</span><span class="n">aH</span><span class="o">*</span><span class="n">alpha_prime</span> <span class="o">+</span> <span class="mf">2.</span><span class="o">*</span><span class="n">aH</span><span class="o">*</span><span class="n">alpha</span> <span class="o">-</span> <span class="n">eta</span><span class="p">)</span> <span class="o">*</span> <span class="n">k_T0_axis</span><span class="p">)</span>
        <span class="c1">#sourceT1 = 0.</span>

        <span class="n">sourceT2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">switch_pol</span> <span class="o">*</span> <span class="n">g</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">sigma_g</span> <span class="o">+</span> <span class="n">Gg0</span> <span class="o">+</span> <span class="n">Gg2</span><span class="p">)</span> <span class="o">/</span> <span class="mf">8.</span>

        <span class="n">sourceE</span>  <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">*</span> <span class="n">sourceT2</span>

        <span class="c1"># Bessel functions</span>
        <span class="n">chiT0</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">tau0</span><span class="o">-</span><span class="n">tau</span><span class="p">,</span> <span class="n">k_T0_axis</span><span class="p">)</span>

        <span class="n">transferT0</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">trapezoid</span><span class="p">(</span>
            <span class="n">sourceT0</span> <span class="o">/</span> <span class="n">aH</span> <span class="o">*</span> <span class="n">phi0</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">chiT0</span><span class="p">),</span>
            <span class="n">lna_axis</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span>
        <span class="p">)</span>

        <span class="n">transferT1</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">trapezoid</span><span class="p">(</span>
            <span class="n">sourceT1</span> <span class="o">/</span> <span class="n">aH</span> <span class="o">*</span> <span class="n">phi1</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">chiT0</span><span class="p">),</span>
            <span class="n">lna_axis</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span>
        <span class="p">)</span>

        <span class="n">transferT2</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">trapezoid</span><span class="p">(</span>
            <span class="n">sourceT2</span> <span class="o">/</span> <span class="n">aH</span> <span class="o">*</span> <span class="n">phi2</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">chiT0</span><span class="p">),</span>
            <span class="n">lna_axis</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span>
        <span class="p">)</span>

        <span class="n">transferE</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">trapezoid</span><span class="p">(</span>
            <span class="n">sourceE</span> <span class="o">/</span> <span class="n">aH</span> <span class="o">*</span> <span class="n">epsilon</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">chiT0</span><span class="p">),</span>
            <span class="n">lna_axis</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span>
        <span class="p">)</span>

        <span class="k">del</span> <span class="n">chiT0</span>

        <span class="n">transferT</span> <span class="o">=</span> <span class="n">transferT0</span> <span class="o">+</span> <span class="n">transferT1</span> <span class="o">+</span> <span class="n">transferT2</span>
        <span class="c1">### END OF TRANSFER FUNCTION ###</span>

        <span class="c1">### LINE OF SIGHT INTEGRAL ###</span>
        <span class="n">integrandTT</span> <span class="o">=</span> <span class="mf">4.</span><span class="o">*</span><span class="n">jnp</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">BG</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;A_s&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">k_T0_axis</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">k_pivot</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="n">BG</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;n_s&#39;</span><span class="p">]</span><span class="o">-</span><span class="mf">1.</span><span class="p">)</span> <span class="o">*</span> <span class="n">transferT</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">k_T0_axis</span>
        <span class="n">integrandTE</span> <span class="o">=</span> <span class="mf">4.</span><span class="o">*</span><span class="n">jnp</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">BG</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;A_s&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">k_T0_axis</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">k_pivot</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="n">BG</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;n_s&#39;</span><span class="p">]</span><span class="o">-</span><span class="mf">1.</span><span class="p">)</span> <span class="o">*</span> <span class="n">transferT</span><span class="o">*</span><span class="n">transferE</span> <span class="o">/</span> <span class="n">k_T0_axis</span>
        <span class="n">integrandEE</span> <span class="o">=</span> <span class="mf">4.</span><span class="o">*</span><span class="n">jnp</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">BG</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;A_s&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">k_T0_axis</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">k_pivot</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="n">BG</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;n_s&#39;</span><span class="p">]</span><span class="o">-</span><span class="mf">1.</span><span class="p">)</span> <span class="o">*</span> <span class="n">transferE</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">k_T0_axis</span>
        <span class="c1">#return k_T0_axis, (integrandTT, integrandTE, integrandEE)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">trapezoid</span><span class="p">(</span><span class="n">integrandTT</span><span class="p">,</span> <span class="n">k_T0_axis</span><span class="p">),</span> <span class="n">jnp</span><span class="o">.</span><span class="n">trapezoid</span><span class="p">(</span><span class="n">integrandTE</span><span class="p">,</span> <span class="n">k_T0_axis</span><span class="p">),</span> <span class="n">jnp</span><span class="o">.</span><span class="n">trapezoid</span><span class="p">(</span><span class="n">integrandEE</span><span class="p">,</span> <span class="n">k_T0_axis</span><span class="p">))</span></div>


<div class="viewcode-block" id="SpectrumSolver.Cl_one_ell_split">
<a class="viewcode-back" href="../../ABCMB.html#ABCMB.spectrum.SpectrumSolver.Cl_one_ell_split">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">Cl_one_ell_split</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">PT</span><span class="p">,</span> <span class="n">BG</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute angular power spectrum for single multipole.</span>

<span class="sd">        Integrates transfer functions over wavenumber.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        idx : int</span>
<span class="sd">            Index into bessel_l_tab for multipole ℓ</span>
<span class="sd">        PT : perturbations.PerturbationTable</span>
<span class="sd">            Perturbation evolution table</span>
<span class="sd">        BG : cosmology.Background</span>
<span class="sd">            Background cosmology module</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        tuple</span>
<span class="sd">            (C_ℓ^TT, C_ℓ^TE, C_ℓ^EE) angular power spectra</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Beyond this k point the bessel function vanishes exponentially.</span>
        <span class="n">k_cut_small</span> <span class="o">=</span> <span class="mf">0.9</span><span class="o">*</span><span class="n">bessel_l_tab</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">/</span><span class="n">BG</span><span class="o">.</span><span class="n">rA_rec</span>

        <span class="c1"># The upperbound of the integral is given by the multipole cut approximation in arxiv:1312.2697</span>
        <span class="c1"># For now, the integration axis is chosen to be a logspaced grid, from kmin to kmin+kcut.</span>
        <span class="c1"># This is because for k&gt;kmin, the integrand ~jl^2 which experiences asymptotic damping for larger k&#39;s.</span>
        <span class="c1"># The peak values of the envelope drop by a few orders of magnitude within 3-4 peaks or so, so its</span>
        <span class="c1"># only really important to have high resolution near kmin. </span>
        <span class="n">k_T0_axis</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">geomspace</span><span class="p">(</span><span class="n">k_cut_small</span><span class="p">,</span> <span class="n">k_cut_small</span><span class="o">+</span><span class="mf">0.15</span><span class="p">,</span> <span class="mi">500</span><span class="p">)</span> 
        <span class="n">k_T1_axis</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">geomspace</span><span class="p">(</span><span class="n">k_cut_small</span><span class="p">,</span> <span class="n">k_cut_small</span><span class="o">+</span><span class="mf">0.04</span><span class="p">,</span> <span class="mi">150</span><span class="p">)</span>
        <span class="n">k_E_axis</span>  <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">geomspace</span><span class="p">(</span><span class="n">k_cut_small</span><span class="p">,</span> <span class="n">k_cut_small</span><span class="o">+</span><span class="mf">0.11</span><span class="p">,</span> <span class="mi">370</span><span class="p">)</span>
        <span class="n">lna_axis</span> <span class="o">=</span> <span class="n">PT</span><span class="o">.</span><span class="n">lna</span>

        <span class="c1">### TRANSFER FUNCTION ###</span>
        <span class="c1"># Background quantities, all Nlna 1D vectors</span>
        <span class="n">tau0</span> <span class="o">=</span> <span class="n">BG</span><span class="o">.</span><span class="n">tau0</span>
        <span class="n">tau</span> <span class="o">=</span> <span class="n">BG</span><span class="o">.</span><span class="n">tau</span><span class="p">(</span><span class="n">lna_axis</span><span class="p">)</span>
        <span class="n">g</span>   <span class="o">=</span> <span class="n">BG</span><span class="o">.</span><span class="n">visibility</span><span class="p">(</span><span class="n">lna_axis</span><span class="p">)</span>
        <span class="n">g_prime</span> <span class="o">=</span> <span class="n">vmap</span><span class="p">(</span><span class="n">grad</span><span class="p">(</span><span class="n">BG</span><span class="o">.</span><span class="n">visibility</span><span class="p">))(</span><span class="n">lna_axis</span><span class="p">)</span> <span class="c1"># Derivative of g w.r.t. lna</span>
        <span class="n">aH</span>  <span class="o">=</span> <span class="n">BG</span><span class="o">.</span><span class="n">aH</span><span class="p">(</span><span class="n">lna_axis</span><span class="p">)</span>
        <span class="n">kappa</span> <span class="o">=</span> <span class="n">BG</span><span class="o">.</span><span class="n">kappa</span><span class="p">(</span><span class="n">lna_axis</span><span class="p">)</span>
        <span class="n">aH_dot</span> <span class="o">=</span> <span class="n">BG</span><span class="o">.</span><span class="n">aH_prime</span><span class="p">(</span><span class="n">lna_axis</span><span class="p">)</span> <span class="o">*</span> <span class="n">aH</span> <span class="c1"># Derivative of aH w.r.t. conformal time tau.</span>

        <span class="n">g</span>        <span class="o">=</span> <span class="n">g</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
        <span class="n">g_prime</span>  <span class="o">=</span> <span class="n">g_prime</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
        <span class="n">aH</span>       <span class="o">=</span> <span class="n">aH</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
        <span class="n">kappa</span>    <span class="o">=</span> <span class="n">kappa</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
        <span class="n">aH_dot</span>   <span class="o">=</span> <span class="n">aH_dot</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>

        <span class="c1"># Perturbations, all (Nk, Nlna) 2D vectors</span>
        <span class="c1">#interp_column = lambda col : jnp.interp(k_T0_axis, PT.k, col)</span>
        <span class="n">interp_column</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">col</span> <span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">k_T0_axis</span><span class="p">),</span> <span class="n">jnp</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">PT</span><span class="o">.</span><span class="n">k</span><span class="p">),</span> <span class="n">col</span><span class="p">)</span>
        <span class="c1">#interp_column = lambda col : tools.fast_interp(jnp.log10(k_T0_axis), jnp.log10(PT.k[0]), jnp.log10(PT.k[-1]), col)</span>

        <span class="c1"># Found that this is much much faster than RegularGridInterpolator</span>
        <span class="n">delta_g</span>       <span class="o">=</span> <span class="n">vmap</span><span class="p">(</span><span class="n">interp_column</span><span class="p">,</span> <span class="n">in_axes</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">out_axes</span><span class="o">=</span><span class="mi">0</span><span class="p">)(</span><span class="n">PT</span><span class="o">.</span><span class="n">delta_g</span><span class="p">)</span>
        <span class="n">theta_b</span>       <span class="o">=</span> <span class="n">vmap</span><span class="p">(</span><span class="n">interp_column</span><span class="p">,</span> <span class="n">in_axes</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">out_axes</span><span class="o">=</span><span class="mi">0</span><span class="p">)(</span><span class="n">PT</span><span class="o">.</span><span class="n">theta_b</span><span class="p">)</span>
        <span class="n">theta_b_prime</span> <span class="o">=</span> <span class="n">vmap</span><span class="p">(</span><span class="n">interp_column</span><span class="p">,</span> <span class="n">in_axes</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">out_axes</span><span class="o">=</span><span class="mi">0</span><span class="p">)(</span><span class="n">PT</span><span class="o">.</span><span class="n">theta_b_prime</span><span class="p">)</span>
        <span class="n">sigma_g</span>       <span class="o">=</span> <span class="n">vmap</span><span class="p">(</span><span class="n">interp_column</span><span class="p">,</span> <span class="n">in_axes</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">out_axes</span><span class="o">=</span><span class="mi">0</span><span class="p">)(</span><span class="n">PT</span><span class="o">.</span><span class="n">sigma_g</span><span class="p">)</span>
        <span class="n">Gg0</span>           <span class="o">=</span> <span class="n">vmap</span><span class="p">(</span><span class="n">interp_column</span><span class="p">,</span> <span class="n">in_axes</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">out_axes</span><span class="o">=</span><span class="mi">0</span><span class="p">)(</span><span class="n">PT</span><span class="o">.</span><span class="n">Gg0</span><span class="p">)</span>
        <span class="n">Gg2</span>           <span class="o">=</span> <span class="n">vmap</span><span class="p">(</span><span class="n">interp_column</span><span class="p">,</span> <span class="n">in_axes</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">out_axes</span><span class="o">=</span><span class="mi">0</span><span class="p">)(</span><span class="n">PT</span><span class="o">.</span><span class="n">Gg2</span><span class="p">)</span>
        <span class="n">eta</span>           <span class="o">=</span> <span class="n">vmap</span><span class="p">(</span><span class="n">interp_column</span><span class="p">,</span> <span class="n">in_axes</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">out_axes</span><span class="o">=</span><span class="mi">0</span><span class="p">)(</span><span class="n">PT</span><span class="o">.</span><span class="n">metric_eta</span><span class="p">)</span>
        <span class="n">eta_prime</span>     <span class="o">=</span> <span class="n">vmap</span><span class="p">(</span><span class="n">interp_column</span><span class="p">,</span> <span class="n">in_axes</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">out_axes</span><span class="o">=</span><span class="mi">0</span><span class="p">)(</span><span class="n">PT</span><span class="o">.</span><span class="n">metric_eta_prime</span><span class="p">)</span>
        <span class="n">alpha</span>         <span class="o">=</span> <span class="n">vmap</span><span class="p">(</span><span class="n">interp_column</span><span class="p">,</span> <span class="n">in_axes</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">out_axes</span><span class="o">=</span><span class="mi">0</span><span class="p">)(</span><span class="n">PT</span><span class="o">.</span><span class="n">metric_alpha</span><span class="p">)</span>
        <span class="n">alpha_prime</span>   <span class="o">=</span> <span class="n">vmap</span><span class="p">(</span><span class="n">interp_column</span><span class="p">,</span> <span class="n">in_axes</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">out_axes</span><span class="o">=</span><span class="mi">0</span><span class="p">)(</span><span class="n">PT</span><span class="o">.</span><span class="n">metric_alpha_prime</span><span class="p">)</span>
        
        <span class="c1">#sourceT0 = self.switch_sw * g * (delta_g/4. + aH*alpha_prime) </span>
        <span class="c1">#sourceT0 = 1.</span>

        <span class="c1"># Source terms</span>
        <span class="c1"># TODO: fix ISW term</span>
        <span class="n">sourceT0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">switch_sw</span> <span class="o">*</span> <span class="n">g</span> <span class="o">*</span> <span class="p">(</span><span class="n">delta_g</span><span class="o">/</span><span class="mf">4.</span> <span class="o">+</span> <span class="n">aH</span><span class="o">*</span><span class="n">alpha_prime</span><span class="p">)</span> \
                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">switch_isw</span> <span class="o">*</span> <span class="p">(</span>
                    <span class="n">g</span> <span class="o">*</span> <span class="p">(</span><span class="n">eta</span> <span class="o">-</span> <span class="n">aH</span><span class="o">*</span><span class="n">alpha_prime</span> <span class="o">-</span> <span class="mf">2.</span><span class="o">*</span><span class="n">aH</span><span class="o">*</span><span class="n">alpha</span><span class="p">)</span> \
                    <span class="o">+</span> <span class="mf">2.</span><span class="o">*</span><span class="n">jnp</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">kappa</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">aH</span><span class="o">*</span><span class="n">eta_prime</span> <span class="o">-</span> <span class="n">aH_dot</span><span class="o">*</span><span class="n">alpha</span> <span class="o">-</span> <span class="n">aH</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">alpha_prime</span><span class="p">)</span>
                <span class="p">)</span> \
                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">switch_dop</span> <span class="o">*</span> <span class="p">(</span>
                    <span class="n">aH</span> <span class="o">*</span> <span class="p">(</span><span class="n">g</span><span class="o">*</span><span class="p">((</span><span class="n">theta_b_prime</span> <span class="o">/</span> <span class="n">k_T0_axis</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">alpha_prime</span><span class="p">)</span> \
                    <span class="o">+</span> <span class="n">g_prime</span><span class="o">*</span><span class="p">((</span><span class="n">theta_b</span> <span class="o">/</span> <span class="n">k_T0_axis</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">alpha</span><span class="p">))</span>
                <span class="p">)</span>
        <span class="c1">#sourceT0 = 0.</span>

        <span class="n">sourceT1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">switch_isw</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">kappa</span><span class="p">)</span> <span class="o">*</span> \
                <span class="p">((</span><span class="n">aH</span><span class="o">*</span><span class="n">alpha_prime</span> <span class="o">+</span> <span class="mf">2.</span><span class="o">*</span><span class="n">aH</span><span class="o">*</span><span class="n">alpha</span> <span class="o">-</span> <span class="n">eta</span><span class="p">)</span> <span class="o">*</span> <span class="n">k_T1_axis</span><span class="p">)</span>
        <span class="c1">#sourceT1 = 0.</span>

        <span class="n">sourceT2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">switch_pol</span> <span class="o">*</span> <span class="n">g</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">sigma_g</span> <span class="o">+</span> <span class="n">Gg0</span> <span class="o">+</span> <span class="n">Gg2</span><span class="p">)</span> <span class="o">/</span> <span class="mf">8.</span>

        <span class="n">sourceE</span>  <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">*</span> <span class="n">sourceT2</span>

        <span class="c1"># Bessel functions</span>
        <span class="c1">#chiT0 = jnp.outer(k_T0_axis, tau0 - tau)</span>
        <span class="c1">#chiT0 = jnp.outer(tau0-tau, k_T0_axis)</span>
        <span class="c1"># chiT1 = jnp.outer(k_T1_axis, tau0 - tau)</span>
        <span class="c1"># chiT2 = jnp.outer(k_T2_axis, tau0 - tau)</span>
        <span class="c1"># chiE  = jnp.outer(k_E_axis, tau0 - tau)</span>

        <span class="c1">#transfer_integrand = sourceT0 / aH  * self.jl(ell, chi) # Shape should be (Nk, Nlna)</span>
        <span class="c1">#transfer = jnp.trapezoid(transfer_integrand, lna_axis) # Shape should be (Nk,)</span>

        <span class="n">chiT0</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">tau0</span><span class="o">-</span><span class="n">tau</span><span class="p">,</span> <span class="n">k_T0_axis</span><span class="p">)</span>
        <span class="n">transferT0</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">trapezoid</span><span class="p">(</span>
            <span class="n">sourceT0</span> <span class="o">/</span> <span class="n">aH</span> <span class="o">*</span> <span class="n">phi0</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">chiT0</span><span class="p">),</span>
            <span class="n">lna_axis</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span>
        <span class="p">)</span>

        <span class="n">transferT2</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">trapezoid</span><span class="p">(</span>
            <span class="n">sourceT2</span> <span class="o">/</span> <span class="n">aH</span> <span class="o">*</span> <span class="n">phi2</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">chiT0</span><span class="p">),</span>
            <span class="n">lna_axis</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span>
        <span class="p">)</span>
        <span class="k">del</span> <span class="n">chiT0</span>

        <span class="n">chiT1</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">k_T1_axis</span><span class="p">,</span> <span class="n">tau0</span> <span class="o">-</span> <span class="n">tau</span><span class="p">)</span>
        <span class="n">transferT1</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">trapezoid</span><span class="p">(</span>
            <span class="n">sourceT1</span> <span class="o">/</span> <span class="n">aH</span> <span class="o">*</span> <span class="n">phi1</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">chiT1</span><span class="p">),</span>
            <span class="n">lna_axis</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span>
        <span class="p">)</span>
        <span class="k">del</span> <span class="n">chiT1</span>

        <span class="n">chiE</span>  <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">k_E_axis</span><span class="p">,</span> <span class="n">tau0</span> <span class="o">-</span> <span class="n">tau</span><span class="p">)</span>
        <span class="n">transferE</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">trapezoid</span><span class="p">(</span>
            <span class="n">sourceE</span> <span class="o">/</span> <span class="n">aH</span> <span class="o">*</span> <span class="n">epsilon</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">chiE</span><span class="p">),</span>
            <span class="n">lna_axis</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span>
        <span class="p">)</span>
        <span class="k">del</span> <span class="n">chiE</span>

        <span class="c1">#transferT = transferT0 + transferT1 + transferT2</span>
        <span class="c1">### END OF TRANSFER FUNCTION ###</span>

        <span class="c1">### LINE OF SIGHT INTEGRAL ###</span>
        <span class="n">integrandTT</span> <span class="o">=</span> <span class="mf">4.</span><span class="o">*</span><span class="n">jnp</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">BG</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;A_s&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">k_T0_axis</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">k_pivot</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="n">BG</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;n_s&#39;</span><span class="p">]</span><span class="o">-</span><span class="mf">1.</span><span class="p">)</span> <span class="o">*</span> <span class="n">transferT</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">k_T0_axis</span>
        <span class="n">integrandTE</span> <span class="o">=</span> <span class="mf">4.</span><span class="o">*</span><span class="n">jnp</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">BG</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;A_s&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">k_T0_axis</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">k_pivot</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="n">BG</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;n_s&#39;</span><span class="p">]</span><span class="o">-</span><span class="mf">1.</span><span class="p">)</span> <span class="o">*</span> <span class="n">transferT</span><span class="o">*</span><span class="n">transferE</span> <span class="o">/</span> <span class="n">k_T0_axis</span>
        <span class="n">integrandEE</span> <span class="o">=</span> <span class="mf">4.</span><span class="o">*</span><span class="n">jnp</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">BG</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;A_s&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">k_T0_axis</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">k_pivot</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="n">BG</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;n_s&#39;</span><span class="p">]</span><span class="o">-</span><span class="mf">1.</span><span class="p">)</span> <span class="o">*</span> <span class="n">transferE</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">k_T0_axis</span>
        <span class="k">return</span> <span class="n">k_T0_axis</span><span class="p">,</span> <span class="p">(</span><span class="n">integrandTT</span><span class="p">,</span> <span class="n">integrandTE</span><span class="p">,</span> <span class="n">integrandEE</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">trapezoid</span><span class="p">(</span><span class="n">integrandTT</span><span class="p">,</span> <span class="n">k_T0_axis</span><span class="p">),</span> <span class="n">jnp</span><span class="o">.</span><span class="n">trapezoid</span><span class="p">(</span><span class="n">integrandTE</span><span class="p">,</span> <span class="n">k_T0_axis</span><span class="p">),</span> <span class="n">jnp</span><span class="o">.</span><span class="n">trapezoid</span><span class="p">(</span><span class="n">integrandEE</span><span class="p">,</span> <span class="n">k_T0_axis</span><span class="p">))</span></div>


        <span class="c1"># integrandTT = 4.*jnp.pi * BG.params[&#39;A_s&#39;] * (k_T0_axis/self.k_pivot)**(BG.params[&#39;n_s&#39;]-1.) * transferT**2 / k_T0_axis</span>
        <span class="c1"># integrandTE = 4.*jnp.pi * BG.params[&#39;A_s&#39;] * (k_T0_axis/self.k_pivot)**(BG.params[&#39;n_s&#39;]-1.) * transferT*transferE / k_T0_axis</span>
        <span class="c1"># integrandEE = 4.*jnp.pi * BG.params[&#39;A_s&#39;] * (k_T0_axis/self.k_pivot)**(BG.params[&#39;n_s&#39;]-1.) * transferE**2 / k_T0_axis</span>
        <span class="c1">#return k_T0_axis, (integrandTT, integrandTE, integrandEE)</span>
        <span class="c1">#return (jnp.trapezoid(integrandTT, jnp.log10(k_T0_axis)), jnp.trapezoid(integrandTE, jnp.log10(k_T0_axis)), jnp.trapezoid(integrandEE, jnp.log10(k_T0_axis)))</span>

    <span class="c1">### OLD CODE ###</span>

    <span class="c1">#@jit</span>
<div class="viewcode-block" id="SpectrumSolver.Cl_one_ell_with_loops">
<a class="viewcode-back" href="../../ABCMB.html#ABCMB.spectrum.SpectrumSolver.Cl_one_ell_with_loops">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">Cl_one_ell_with_loops</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ell_idx</span><span class="p">,</span> <span class="n">PT</span><span class="p">,</span> <span class="n">BG</span><span class="p">):</span>
        <span class="n">k_cut_small</span> <span class="o">=</span> <span class="n">bessel_l_tab</span><span class="p">[</span><span class="n">ell_idx</span><span class="p">]</span><span class="o">/</span><span class="n">BG</span><span class="o">.</span><span class="n">rA_rec</span>
        <span class="n">k_T0_axis</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">k_cut_small</span><span class="p">,</span> <span class="n">k_cut_small</span><span class="o">+</span><span class="mf">0.075</span><span class="p">,</span> <span class="mi">500</span><span class="p">)</span>
        <span class="n">k_T1_axis</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">k_cut_small</span><span class="p">,</span> <span class="n">k_cut_small</span><span class="o">+</span><span class="mf">0.02</span><span class="p">,</span> <span class="mi">130</span><span class="p">)</span>
        <span class="n">k_T2_axis</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">k_cut_small</span><span class="p">,</span> <span class="n">k_cut_small</span><span class="o">+</span><span class="mf">0.075</span><span class="p">,</span> <span class="mi">500</span><span class="p">)</span>
        <span class="n">k_E_axis</span>  <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">k_cut_small</span><span class="p">,</span> <span class="n">k_cut_small</span><span class="o">+</span><span class="mf">0.055</span><span class="p">,</span> <span class="mi">360</span><span class="p">)</span>

        <span class="c1">#lna_max = BG.lna_visibility_stop # It&#39;d be ideal to implement this time cut.</span>
        <span class="c1">#lna_max = PT.lna[-1]</span>

        <span class="c1">#This is slow</span>
        <span class="c1"># lna_max = jnp.where(</span>
        <span class="c1">#     bessel_l_tab[ell_idx] &lt;= 400,</span>
        <span class="c1">#     BG.lna_visibility_stop,</span>
        <span class="c1">#     PT.lna[-1]</span>
        <span class="c1"># )</span>

        <span class="c1"># N_steps = jnp.where(</span>
        <span class="c1">#     bessel_l_tab[ell_idx] &lt;= 400,</span>
        <span class="c1">#     43,</span>
        <span class="c1">#     PT.lna.size</span>
        <span class="c1"># )</span>


        <span class="c1">###################</span>
        <span class="c1">### TRANSFER T0 ###</span>
        <span class="c1">################### </span>
        
        <span class="c1"># def scan_T0(carry, k):</span>
        <span class="c1">#     val = self.integrate_trapezoid_while_loop(ell_idx, k, self.integrand_T0, PT, BG)</span>
        <span class="c1">#     return carry, val</span>
        
        <span class="c1"># _, transferT0 = lax.scan(scan_T0, None, k_T0_axis)</span>

        <span class="c1"># Wow vmap works here and is twice as fast as scan!!</span>
        <span class="n">f</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">k</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">integrate_trapezoid_while_loop</span><span class="p">(</span><span class="n">ell_idx</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">integrand_T0</span><span class="p">,</span> <span class="n">PT</span><span class="p">,</span> <span class="n">BG</span><span class="p">)</span>
        <span class="c1">#f = lambda k : self.integrate_trapezoid_trapz(ell_idx, k, self.integrand_T0, N_steps, PT, BG)</span>
        <span class="c1">#f = lambda k : self.integrate_trapezoid_scan(ell_idx, k, self.integrand_T0, PT, BG)</span>
        <span class="c1">#f = lambda k : self.integrate_trapezoid_vmap_scan(ell_idx, k, self.integrand_T0, PT, BG)</span>
        <span class="n">transferT0</span> <span class="o">=</span> <span class="n">vmap</span><span class="p">(</span><span class="n">f</span><span class="p">)(</span><span class="n">k_T0_axis</span><span class="p">)</span>

        <span class="c1"># ###################</span>
        <span class="c1"># ### TRANSFER T1 ###</span>
        <span class="c1"># ################### </span>
        
        <span class="c1"># # def scan_T1(carry, k):</span>
        <span class="c1"># #     val = self.integrate_trapezoid_while_loop(ell_idx, k, self.integrand_T1, PT, BG)</span>
        <span class="c1"># #     return carry, val</span>
        
        <span class="c1"># # _, transferT1 = lax.scan(scan_T1, None, k_T0_axis)</span>
        <span class="c1"># f = lambda k : self.integrate_trapezoid_while_loop(ell_idx, k, self.integrand_T1, lna_max, PT, BG)</span>
        <span class="c1"># transferT1 = vmap(f)(k_T0_axis)</span>

        <span class="c1"># ###################</span>
        <span class="c1"># ### TRANSFER T2 ###</span>
        <span class="c1"># ################### </span>
        
        <span class="c1"># # def scan_T2(carry, k):</span>
        <span class="c1"># #     val = self.integrate_trapezoid_while_loop(ell_idx, k, self.integrand_T2, PT, BG)</span>
        <span class="c1"># #     return carry, val</span>
        
        <span class="c1"># # _, transferT2 = lax.scan(scan_T2, None, k_T0_axis)</span>
        <span class="c1"># f = lambda k : self.integrate_trapezoid_while_loop(ell_idx, k, self.integrand_T2, lna_max, PT, BG)</span>
        <span class="c1"># transferT2 = vmap(f)(k_T0_axis)</span>

        <span class="c1"># ###################</span>
        <span class="c1"># ### TRANSFER E ###</span>
        <span class="c1"># ################### </span>
        
        <span class="c1"># # def scan_E(carry, k):</span>
        <span class="c1"># #     val = self.integrate_trapezoid_while_loop(ell_idx, k, self.integrand_E, PT, BG)</span>
        <span class="c1"># #     return carry, val</span>
        
        <span class="c1"># # _, transferE = lax.scan(scan_E, None, k_T0_axis)</span>
        <span class="c1"># f = lambda k : self.integrate_trapezoid_while_loop(ell_idx, k, self.integrand_E, lna_max, PT, BG)</span>
        <span class="c1"># transferE = vmap(f)(k_T0_axis)</span>

        <span class="n">transferT</span> <span class="o">=</span> <span class="n">transferT0</span> <span class="c1">#+ transferT1 + transferT2</span>
        <span class="c1">#transferT = transferT0 + tools.fast_interp(k_T0_axis, k_T1_axis[0], k_T1_axis[-1], transferT1) + tools.fast_interp(k_T0_axis, k_T2_axis[0], k_T2_axis[-1], transferT2)</span>
        <span class="c1">#transferE = tools.fast_interp(k_T0_axis, k_E_axis[0], k_E_axis[-1], transferE)</span>

        <span class="n">integrandTT</span> <span class="o">=</span> <span class="mf">4.</span><span class="o">*</span><span class="n">jnp</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">BG</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;A_s&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">k_T0_axis</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">k_pivot</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="n">BG</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;n_s&#39;</span><span class="p">]</span><span class="o">-</span><span class="mf">1.</span><span class="p">)</span> <span class="o">*</span> <span class="n">transferT</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">k_T0_axis</span>
        <span class="c1">#integrandTE = 4.*jnp.pi * BG.params[&#39;A_s&#39;] * (k_T0_axis/self.k_pivot)**(BG.params[&#39;n_s&#39;]-1.) * transferT*transferE / k_T0_axis</span>
        <span class="c1">#integrandEE = 4.*jnp.pi * BG.params[&#39;A_s&#39;] * (k_T0_axis/self.k_pivot)**(BG.params[&#39;n_s&#39;]-1.) * transferE**2 / k_T0_axis</span>
        <span class="c1">#return (jnp.trapezoid(integrandTT, k_T0_axis), jnp.trapezoid(integrandTE, k_T0_axis), jnp.trapezoid(integrandEE, k_T0_axis))</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">trapezoid</span><span class="p">(</span><span class="n">integrandTT</span><span class="p">,</span> <span class="n">k_T0_axis</span><span class="p">),</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span></div>


<div class="viewcode-block" id="SpectrumSolver.integrate_trapezoid_scan">
<a class="viewcode-back" href="../../ABCMB.html#ABCMB.spectrum.SpectrumSolver.integrate_trapezoid_scan">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">integrate_trapezoid_scan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ell_idx</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">integrand</span><span class="p">,</span> <span class="n">PT</span><span class="p">,</span> <span class="n">BG</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Trapezoid rule using lax.scan, computing integrand at each step.</span>
<span class="sd">        No precomputation with vmap. Integrates over N_steps of PT.lna.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">dlna</span> <span class="o">=</span> <span class="n">PT</span><span class="o">.</span><span class="n">lna</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">PT</span><span class="o">.</span><span class="n">lna</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># Assumes uniform spacing</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">scan_body</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
            <span class="n">acc</span><span class="p">,</span> <span class="n">f_prev</span> <span class="o">=</span> <span class="n">state</span>
            <span class="n">f_next</span> <span class="o">=</span> <span class="n">integrand</span><span class="p">(</span><span class="n">ell_idx</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">PT</span><span class="p">,</span> <span class="n">BG</span><span class="p">)</span>
            <span class="n">area</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">dlna</span> <span class="o">*</span> <span class="p">(</span><span class="n">f_prev</span> <span class="o">+</span> <span class="n">f_next</span><span class="p">)</span>
            <span class="n">new_acc</span> <span class="o">=</span> <span class="n">acc</span> <span class="o">+</span> <span class="n">area</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">new_acc</span><span class="p">,</span> <span class="n">f_next</span><span class="p">),</span> <span class="kc">None</span>

        <span class="c1"># Initial state</span>
        <span class="n">f0</span> <span class="o">=</span> <span class="n">integrand</span><span class="p">(</span><span class="n">ell_idx</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PT</span><span class="p">,</span> <span class="n">BG</span><span class="p">)</span>
        <span class="n">init_state</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">f0</span><span class="p">)</span>

        <span class="p">(</span><span class="n">final_acc</span><span class="p">,</span> <span class="n">_</span><span class="p">),</span> <span class="n">_</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span><span class="n">scan_body</span><span class="p">,</span> <span class="n">init_state</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">PT</span><span class="o">.</span><span class="n">lna</span><span class="o">.</span><span class="n">size</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">final_acc</span></div>


<div class="viewcode-block" id="SpectrumSolver.integrate_trapezoid_vmap_scan">
<a class="viewcode-back" href="../../ABCMB.html#ABCMB.spectrum.SpectrumSolver.integrate_trapezoid_vmap_scan">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">integrate_trapezoid_vmap_scan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ell_idx</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">integrand</span><span class="p">,</span> <span class="n">PT</span><span class="p">,</span> <span class="n">BG</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Trapezoidal integrator using lax.scan over a fixed number of steps N_steps.</span>
<span class="sd">        integrand(ell_idx, k, lna_idx, PT, BG) returns the value at each step.</span>
<span class="sd">        PT.lna is assumed to be uniformly spaced.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dlna</span> <span class="o">=</span> <span class="n">PT</span><span class="o">.</span><span class="n">lna</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">PT</span><span class="o">.</span><span class="n">lna</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># assumes uniform spacing</span>

        <span class="c1"># Precompute all needed function values</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">PT</span><span class="o">.</span><span class="n">lna</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
        <span class="n">f_vals</span> <span class="o">=</span> <span class="n">vmap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> <span class="n">integrand</span><span class="p">(</span><span class="n">ell_idx</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">PT</span><span class="p">,</span> <span class="n">BG</span><span class="p">))(</span><span class="n">indices</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">scan_body</span><span class="p">(</span><span class="n">acc</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
            <span class="n">area</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">dlna</span> <span class="o">*</span> <span class="p">(</span><span class="n">f_vals</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">f_vals</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">acc</span> <span class="o">+</span> <span class="n">area</span><span class="p">,</span> <span class="kc">None</span>

        <span class="n">integral</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span><span class="n">scan_body</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">PT</span><span class="o">.</span><span class="n">lna</span><span class="o">.</span><span class="n">size</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">integral</span></div>


<div class="viewcode-block" id="SpectrumSolver.integrate_trapezoid_trapz">
<a class="viewcode-back" href="../../ABCMB.html#ABCMB.spectrum.SpectrumSolver.integrate_trapezoid_trapz">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">integrate_trapezoid_trapz</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ell_idx</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">integrand</span><span class="p">,</span> <span class="n">N_steps</span><span class="p">,</span> <span class="n">PT</span><span class="p">,</span> <span class="n">BG</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Integrate using jnp.trapz over N_steps of PT.lna and integrand values.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">N_steps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">lna_slice</span> <span class="o">=</span> <span class="n">PT</span><span class="o">.</span><span class="n">lna</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span>
        <span class="n">f_vals</span> <span class="o">=</span> <span class="n">vmap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> <span class="n">integrand</span><span class="p">(</span><span class="n">ell_idx</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">PT</span><span class="p">,</span> <span class="n">BG</span><span class="p">))(</span><span class="n">indices</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">trapezoid</span><span class="p">(</span><span class="n">f_vals</span><span class="p">,</span> <span class="n">lna_slice</span><span class="p">)</span></div>


<div class="viewcode-block" id="SpectrumSolver.integrate_trapezoid_while_loop">
<a class="viewcode-back" href="../../ABCMB.html#ABCMB.spectrum.SpectrumSolver.integrate_trapezoid_while_loop">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">integrate_trapezoid_while_loop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ell_idx</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">integrand</span><span class="p">,</span> <span class="n">PT</span><span class="p">,</span> <span class="n">BG</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A while loop trapezoid rule integrator.</span>
<span class="sd">        Specifically used for integrating across lna for transfer function, given k.</span>

<span class="sd">        integrand should take (ell_idx, k, lna_idx) and return the integrand.</span>

<span class="sd">        Returns the transfer function for one ell and k value.</span>
<span class="sd">        &quot;&quot;&quot;</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        lna_vals = jnp.linspace(BG.lna_transfer_start, 0.0, 3000)</span>
<span class="sd">        lna_max = lna_vals[jnp.argmin((BG.tau(lna_vals)-BG.tau0+bessel_stop_tab[ell_idx]/k)**2)]</span>

<span class="sd">        def stop_condition(lna_idx):</span>
<span class="sd">            #Stop integrating when argument is past the ell of the bessel function.</span>
<span class="sd">            # Found that run time is heavily dependent on this stop cond.</span>
<span class="sd">            #return k*(BG.tau0-BG.tau(PT.lna[lna_idx])) &gt; 0.9*bessel_l_tab[ell_idx]</span>
<span class="sd">            #return k*(BG.tau0-BG.tau(PT.lna[lna_idx])) &gt; bessel_stop_tab[ell_idx]</span>
<span class="sd">            #return PT.lna[lna_idx] &lt; -6.6</span>
<span class="sd">            return True</span>
<span class="sd">            #return PT.lna[lna_idx] &lt; lna_max</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">cond_fun</span><span class="p">(</span><span class="n">state</span><span class="p">):</span>
            <span class="n">lna_idx</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">state</span>
            <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">lna_idx</span><span class="o">+</span><span class="mi">1</span> <span class="o">&lt;</span> <span class="n">PT</span><span class="o">.</span><span class="n">lna</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">k</span><span class="o">*</span><span class="p">(</span><span class="n">BG</span><span class="o">.</span><span class="n">tau0</span><span class="o">-</span><span class="n">BG</span><span class="o">.</span><span class="n">tau</span><span class="p">(</span><span class="n">PT</span><span class="o">.</span><span class="n">lna</span><span class="p">[</span><span class="n">lna_idx</span><span class="p">]))</span> <span class="o">&gt;</span> <span class="n">bessel_stop_tab</span><span class="p">[</span><span class="n">ell_idx</span><span class="p">])</span>
            <span class="c1">#return lna_idx+1 &lt; PT.lna.size</span>
            <span class="c1">#return PT.lna[lna_idx] &lt; -6.6</span>
            <span class="c1">#return k*(BG.tau0-BG.tau(PT.lna[lna_idx])) &gt; bessel_stop_tab[ell_idx]</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">body_fun</span><span class="p">(</span><span class="n">state</span><span class="p">):</span>
            <span class="n">lna_idx</span><span class="p">,</span> <span class="n">acc</span><span class="p">,</span> <span class="n">f_prev</span> <span class="o">=</span> <span class="n">state</span>
            <span class="n">f_next</span> <span class="o">=</span> <span class="n">integrand</span><span class="p">(</span><span class="n">ell_idx</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">lna_idx</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">PT</span><span class="p">,</span> <span class="n">BG</span><span class="p">)</span>
            <span class="n">area</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">PT</span><span class="o">.</span><span class="n">lna</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">PT</span><span class="o">.</span><span class="n">lna</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="n">f_prev</span> <span class="o">+</span> <span class="n">f_next</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">lna_idx</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">acc</span> <span class="o">+</span> <span class="n">area</span><span class="p">,</span> <span class="n">f_next</span><span class="p">)</span>

        <span class="c1"># Precompute initial f0</span>
        <span class="n">f0</span> <span class="o">=</span> <span class="n">integrand</span><span class="p">(</span><span class="n">ell_idx</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PT</span><span class="p">,</span> <span class="n">BG</span><span class="p">)</span>
        <span class="n">init_state</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">f0</span><span class="p">)</span>

        <span class="n">_</span><span class="p">,</span> <span class="n">integral</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">while_loop</span><span class="p">(</span><span class="n">cond_fun</span><span class="p">,</span> <span class="n">body_fun</span><span class="p">,</span> <span class="n">init_state</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">integral</span></div>



<div class="viewcode-block" id="SpectrumSolver.integrand_T0">
<a class="viewcode-back" href="../../ABCMB.html#ABCMB.spectrum.SpectrumSolver.integrand_T0">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">integrand_T0</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ell_idx</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">lna_idx</span><span class="p">,</span> <span class="n">PT</span><span class="p">,</span> <span class="n">BG</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute temperature source function integrand.</span>

<span class="sd">        Calculates the integrand for SW, ISW, and Doppler contributions.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        ell_idx : int</span>
<span class="sd">            Index into bessel_l_tab for multipole ℓ</span>
<span class="sd">        k : float</span>
<span class="sd">            Wavenumber (units: Mpc^{-1})</span>
<span class="sd">        lna_idx : int</span>
<span class="sd">            Index into time grid</span>
<span class="sd">        PT : perturbations.PerturbationTable</span>
<span class="sd">            Perturbation evolution table</span>
<span class="sd">        BG : cosmology.Background</span>
<span class="sd">            Background cosmology module</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        float</span>
<span class="sd">            Temperature source integrand</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Background</span>
        <span class="n">lna</span> <span class="o">=</span> <span class="n">PT</span><span class="o">.</span><span class="n">lna</span><span class="p">[</span><span class="n">lna_idx</span><span class="p">]</span> <span class="c1"># Current scale factor</span>
        <span class="n">chi</span> <span class="o">=</span> <span class="n">k</span><span class="o">*</span><span class="p">(</span><span class="n">BG</span><span class="o">.</span><span class="n">tau0</span><span class="o">-</span><span class="n">BG</span><span class="o">.</span><span class="n">tau</span><span class="p">(</span><span class="n">lna</span><span class="p">))</span> <span class="c1"># Argument of phi0</span>
        <span class="n">aH</span> <span class="o">=</span> <span class="n">BG</span><span class="o">.</span><span class="n">aH</span><span class="p">(</span><span class="n">lna</span><span class="p">)</span>
        <span class="n">aH_dot</span> <span class="o">=</span> <span class="n">BG</span><span class="o">.</span><span class="n">aH_prime</span><span class="p">(</span><span class="n">lna</span><span class="p">)</span> <span class="o">*</span> <span class="n">aH</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">BG</span><span class="o">.</span><span class="n">visibility</span><span class="p">(</span><span class="n">lna</span><span class="p">)</span>
        <span class="n">g_prime</span> <span class="o">=</span> <span class="n">grad</span><span class="p">(</span><span class="n">BG</span><span class="o">.</span><span class="n">visibility</span><span class="p">)(</span><span class="n">lna</span><span class="p">)</span>
        <span class="n">kappa</span> <span class="o">=</span> <span class="n">BG</span><span class="o">.</span><span class="n">kappa</span><span class="p">(</span><span class="n">lna</span><span class="p">)</span>

        <span class="c1"># Interpolate perturbation solutions</span>
        <span class="c1"># delta_g = jnp.interp(k, PT.k, PT.delta_g[:, lna_idx])</span>
        <span class="c1"># theta_b = jnp.interp(k, PT.k, PT.theta_b[:, lna_idx])</span>
        <span class="c1"># theta_b_prime = jnp.interp(k, PT.k, PT.theta_b_prime[:, lna_idx])</span>
        <span class="c1"># alpha = jnp.interp(k, PT.k, PT.metric_alpha[:, lna_idx])</span>
        <span class="c1"># alpha_prime = jnp.interp(k, PT.k, PT.metric_alpha_prime[:, lna_idx])</span>
        <span class="c1"># eta = jnp.interp(k, PT.k, PT.metric_eta[:, lna_idx])</span>
        <span class="c1"># eta_prime = jnp.interp(k, PT.k, PT.metric_eta_prime[:, lna_idx])</span>

        <span class="c1"># Faster with fast_interp</span>
        <span class="n">logk</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
        <span class="n">logk_axis</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">PT</span><span class="o">.</span><span class="n">k</span><span class="p">)</span>
        <span class="n">delta_g</span> <span class="o">=</span> <span class="n">tools</span><span class="o">.</span><span class="n">fast_interp</span><span class="p">(</span><span class="n">logk</span><span class="p">,</span> <span class="n">logk_axis</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">logk_axis</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">PT</span><span class="o">.</span><span class="n">delta_g</span><span class="p">[:,</span> <span class="n">lna_idx</span><span class="p">])</span>
        <span class="n">theta_b</span> <span class="o">=</span> <span class="n">tools</span><span class="o">.</span><span class="n">fast_interp</span><span class="p">(</span><span class="n">logk</span><span class="p">,</span> <span class="n">logk_axis</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">logk_axis</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">PT</span><span class="o">.</span><span class="n">theta_b</span><span class="p">[:,</span> <span class="n">lna_idx</span><span class="p">])</span>
        <span class="n">theta_b_prime</span> <span class="o">=</span> <span class="n">tools</span><span class="o">.</span><span class="n">fast_interp</span><span class="p">(</span><span class="n">logk</span><span class="p">,</span> <span class="n">logk_axis</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">logk_axis</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">PT</span><span class="o">.</span><span class="n">theta_b_prime</span><span class="p">[:,</span> <span class="n">lna_idx</span><span class="p">])</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="n">tools</span><span class="o">.</span><span class="n">fast_interp</span><span class="p">(</span><span class="n">logk</span><span class="p">,</span> <span class="n">logk_axis</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">logk_axis</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">PT</span><span class="o">.</span><span class="n">metric_alpha</span><span class="p">[:,</span> <span class="n">lna_idx</span><span class="p">])</span>
        <span class="n">alpha_prime</span> <span class="o">=</span> <span class="n">tools</span><span class="o">.</span><span class="n">fast_interp</span><span class="p">(</span><span class="n">logk</span><span class="p">,</span> <span class="n">logk_axis</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">logk_axis</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">PT</span><span class="o">.</span><span class="n">metric_alpha_prime</span><span class="p">[:,</span> <span class="n">lna_idx</span><span class="p">])</span>
        <span class="n">eta</span> <span class="o">=</span> <span class="n">tools</span><span class="o">.</span><span class="n">fast_interp</span><span class="p">(</span><span class="n">logk</span><span class="p">,</span> <span class="n">logk_axis</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">logk_axis</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">PT</span><span class="o">.</span><span class="n">metric_eta</span><span class="p">[:,</span> <span class="n">lna_idx</span><span class="p">])</span>
        <span class="n">eta_prime</span> <span class="o">=</span> <span class="n">tools</span><span class="o">.</span><span class="n">fast_interp</span><span class="p">(</span><span class="n">logk</span><span class="p">,</span> <span class="n">logk_axis</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">logk_axis</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">PT</span><span class="o">.</span><span class="n">metric_eta_prime</span><span class="p">[:,</span> <span class="n">lna_idx</span><span class="p">])</span>

        <span class="c1">### Source Function ###</span>
        <span class="n">sourceT0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">switch_sw</span> <span class="o">*</span> <span class="n">g</span> <span class="o">*</span> <span class="p">(</span><span class="n">delta_g</span><span class="o">/</span><span class="mf">4.</span> <span class="o">+</span> <span class="n">aH</span><span class="o">*</span><span class="n">alpha_prime</span><span class="p">)</span> \
                    <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">switch_isw</span> <span class="o">*</span> <span class="p">(</span>
                    <span class="n">g</span> <span class="o">*</span> <span class="p">(</span> <span class="n">eta</span> <span class="o">-</span> <span class="n">aH</span><span class="o">*</span><span class="n">alpha_prime</span> <span class="o">-</span> <span class="mf">2.</span><span class="o">*</span><span class="n">aH</span><span class="o">*</span><span class="n">alpha</span> <span class="p">)</span> \
                    <span class="o">+</span> <span class="mf">2.</span><span class="o">*</span><span class="n">jnp</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">kappa</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span> <span class="n">aH</span><span class="o">*</span><span class="n">eta_prime</span> <span class="o">-</span> <span class="n">aH_dot</span><span class="o">*</span><span class="n">alpha</span> <span class="o">-</span> <span class="n">aH</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">alpha_prime</span> <span class="p">)</span>
                    <span class="p">)</span> \
                    <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">switch_dop</span> <span class="o">*</span> <span class="p">(</span>
                    <span class="n">aH</span> <span class="o">*</span> <span class="p">(</span><span class="n">g</span><span class="o">*</span><span class="p">(</span><span class="n">theta_b_prime</span><span class="o">/</span><span class="n">k</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">alpha_prime</span><span class="p">)</span> <span class="o">+</span> <span class="n">g_prime</span><span class="o">*</span><span class="p">(</span><span class="n">theta_b</span><span class="o">/</span><span class="n">k</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">alpha</span><span class="p">))</span>
                    <span class="p">)</span>
        <span class="c1">#sourceT0 = self.switch_sw * g * (delta_g/4. + aH*alpha_prime)</span>

        <span class="c1">#return phi0(ell_idx, chi) / aH</span>
        <span class="k">return</span> <span class="n">sourceT0</span> <span class="o">*</span> <span class="n">phi0</span><span class="p">(</span><span class="n">ell_idx</span><span class="p">,</span> <span class="n">chi</span><span class="p">)</span> <span class="o">/</span> <span class="n">aH</span></div>


<div class="viewcode-block" id="SpectrumSolver.integrand_T1">
<a class="viewcode-back" href="../../ABCMB.html#ABCMB.spectrum.SpectrumSolver.integrand_T1">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">integrand_T1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ell_idx</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">lna_idx</span><span class="p">,</span> <span class="n">PT</span><span class="p">,</span> <span class="n">BG</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute ISW temperature source function integrand.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        ell_idx : int</span>
<span class="sd">            Index into bessel_l_tab for multipole ℓ</span>
<span class="sd">        k : float</span>
<span class="sd">            Wavenumber (units: Mpc^{-1})</span>
<span class="sd">        lna_idx : int</span>
<span class="sd">            Index into time grid</span>
<span class="sd">        PT : perturbations.PerturbationTable</span>
<span class="sd">            Perturbation evolution table</span>
<span class="sd">        BG : cosmology.Background</span>
<span class="sd">            Background cosmology module</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        float</span>
<span class="sd">            ISW temperature source integrand</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Background</span>
        <span class="n">lna</span> <span class="o">=</span> <span class="n">PT</span><span class="o">.</span><span class="n">lna</span><span class="p">[</span><span class="n">lna_idx</span><span class="p">]</span> <span class="c1"># Current scale factor</span>
        <span class="n">chi</span> <span class="o">=</span> <span class="n">k</span><span class="o">*</span><span class="p">(</span><span class="n">BG</span><span class="o">.</span><span class="n">tau0</span><span class="o">-</span><span class="n">BG</span><span class="o">.</span><span class="n">tau</span><span class="p">(</span><span class="n">lna</span><span class="p">))</span> <span class="c1"># Argument of phi0</span>
        <span class="n">aH</span> <span class="o">=</span> <span class="n">BG</span><span class="o">.</span><span class="n">aH</span><span class="p">(</span><span class="n">lna</span><span class="p">)</span>
        <span class="n">kappa</span> <span class="o">=</span> <span class="n">BG</span><span class="o">.</span><span class="n">kappa</span><span class="p">(</span><span class="n">lna</span><span class="p">)</span>

        <span class="c1"># Interpolate perturbation solutions</span>
        <span class="n">logk</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
        <span class="n">logk_axis</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">PT</span><span class="o">.</span><span class="n">k</span><span class="p">)</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="n">tools</span><span class="o">.</span><span class="n">fast_interp</span><span class="p">(</span><span class="n">logk</span><span class="p">,</span> <span class="n">logk_axis</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">logk_axis</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">PT</span><span class="o">.</span><span class="n">metric_alpha</span><span class="p">[:,</span> <span class="n">lna_idx</span><span class="p">])</span>
        <span class="n">alpha_prime</span> <span class="o">=</span> <span class="n">tools</span><span class="o">.</span><span class="n">fast_interp</span><span class="p">(</span><span class="n">logk</span><span class="p">,</span> <span class="n">logk_axis</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">logk_axis</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">PT</span><span class="o">.</span><span class="n">metric_alpha_prime</span><span class="p">[:,</span> <span class="n">lna_idx</span><span class="p">])</span>
        <span class="n">eta</span> <span class="o">=</span> <span class="n">tools</span><span class="o">.</span><span class="n">fast_interp</span><span class="p">(</span><span class="n">logk</span><span class="p">,</span> <span class="n">logk_axis</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">logk_axis</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">PT</span><span class="o">.</span><span class="n">metric_eta</span><span class="p">[:,</span> <span class="n">lna_idx</span><span class="p">])</span>

        <span class="c1">### Source Function ###</span>
        <span class="n">sourceT1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">switch_isw</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">kappa</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">aH</span><span class="o">*</span><span class="n">alpha_prime</span> <span class="o">+</span> <span class="mf">2.</span><span class="o">*</span><span class="n">aH</span><span class="o">*</span><span class="n">alpha</span> <span class="o">-</span> <span class="n">eta</span><span class="p">)</span> <span class="o">*</span> <span class="n">k</span>

        <span class="k">return</span> <span class="n">sourceT1</span> <span class="o">*</span> <span class="n">phi1</span><span class="p">(</span><span class="n">ell_idx</span><span class="p">,</span> <span class="n">chi</span><span class="p">)</span> <span class="o">/</span> <span class="n">aH</span></div>

    
<div class="viewcode-block" id="SpectrumSolver.integrand_T2">
<a class="viewcode-back" href="../../ABCMB.html#ABCMB.spectrum.SpectrumSolver.integrand_T2">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">integrand_T2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ell_idx</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">lna_idx</span><span class="p">,</span> <span class="n">PT</span><span class="p">,</span> <span class="n">BG</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute polarization temperature source function integrand.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        ell_idx : int</span>
<span class="sd">            Index into bessel_l_tab for multipole ℓ</span>
<span class="sd">        k : float</span>
<span class="sd">            Wavenumber (units: Mpc^{-1})</span>
<span class="sd">        lna_idx : int</span>
<span class="sd">            Index into time grid</span>
<span class="sd">        PT : perturbations.PerturbationTable</span>
<span class="sd">            Perturbation evolution table</span>
<span class="sd">        BG : cosmology.Background</span>
<span class="sd">            Background cosmology module</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        float</span>
<span class="sd">            Polarization temperature source integrand</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Background</span>
        <span class="n">lna</span> <span class="o">=</span> <span class="n">PT</span><span class="o">.</span><span class="n">lna</span><span class="p">[</span><span class="n">lna_idx</span><span class="p">]</span> <span class="c1"># Current scale factor</span>
        <span class="n">chi</span> <span class="o">=</span> <span class="n">k</span><span class="o">*</span><span class="p">(</span><span class="n">BG</span><span class="o">.</span><span class="n">tau0</span><span class="o">-</span><span class="n">BG</span><span class="o">.</span><span class="n">tau</span><span class="p">(</span><span class="n">lna</span><span class="p">))</span> <span class="c1"># Argument of phi0</span>
        <span class="n">aH</span> <span class="o">=</span> <span class="n">BG</span><span class="o">.</span><span class="n">aH</span><span class="p">(</span><span class="n">lna</span><span class="p">)</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">BG</span><span class="o">.</span><span class="n">visibility</span><span class="p">(</span><span class="n">lna</span><span class="p">)</span>

        <span class="c1"># Interpolate perturbation solutions</span>
        <span class="n">logk</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
        <span class="n">logk_axis</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">PT</span><span class="o">.</span><span class="n">k</span><span class="p">)</span>
        <span class="n">Fg2</span> <span class="o">=</span> <span class="n">tools</span><span class="o">.</span><span class="n">fast_interp</span><span class="p">(</span><span class="n">logk</span><span class="p">,</span> <span class="n">logk_axis</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">logk_axis</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">PT</span><span class="o">.</span><span class="n">Fg2</span><span class="p">[:,</span> <span class="n">lna_idx</span><span class="p">])</span>
        <span class="n">Gg0</span> <span class="o">=</span> <span class="n">tools</span><span class="o">.</span><span class="n">fast_interp</span><span class="p">(</span><span class="n">logk</span><span class="p">,</span> <span class="n">logk_axis</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">logk_axis</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">PT</span><span class="o">.</span><span class="n">Gg0</span><span class="p">[:,</span> <span class="n">lna_idx</span><span class="p">])</span>
        <span class="n">Gg2</span> <span class="o">=</span> <span class="n">tools</span><span class="o">.</span><span class="n">fast_interp</span><span class="p">(</span><span class="n">logk</span><span class="p">,</span> <span class="n">logk_axis</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">logk_axis</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">PT</span><span class="o">.</span><span class="n">Gg2</span><span class="p">[:,</span> <span class="n">lna_idx</span><span class="p">])</span>

        <span class="c1">### Source Function ###</span>
        <span class="n">sourceT2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">switch_pol</span> <span class="o">*</span> <span class="n">g</span> <span class="o">*</span> <span class="p">(</span><span class="n">Fg2</span><span class="o">+</span><span class="n">Gg0</span><span class="o">+</span><span class="n">Gg2</span><span class="p">)</span> <span class="o">/</span> <span class="mf">8.</span>

        <span class="k">return</span> <span class="n">sourceT2</span> <span class="o">*</span> <span class="n">phi2</span><span class="p">(</span><span class="n">ell_idx</span><span class="p">,</span> <span class="n">chi</span><span class="p">)</span> <span class="o">/</span> <span class="n">aH</span></div>

    
<div class="viewcode-block" id="SpectrumSolver.integrand_E">
<a class="viewcode-back" href="../../ABCMB.html#ABCMB.spectrum.SpectrumSolver.integrand_E">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">integrand_E</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ell_idx</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">lna_idx</span><span class="p">,</span> <span class="n">PT</span><span class="p">,</span> <span class="n">BG</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute E-mode polarization source function integrand.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        ell_idx : int</span>
<span class="sd">            Index into bessel_l_tab for multipole ℓ</span>
<span class="sd">        k : float</span>
<span class="sd">            Wavenumber (units: Mpc^{-1})</span>
<span class="sd">        lna_idx : int</span>
<span class="sd">            Index into time grid</span>
<span class="sd">        PT : perturbations.PerturbationTable</span>
<span class="sd">            Perturbation evolution table</span>
<span class="sd">        BG : cosmology.Background</span>
<span class="sd">            Background cosmology module</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        float</span>
<span class="sd">            E-mode polarization source integrand</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Background</span>
        <span class="n">lna</span> <span class="o">=</span> <span class="n">PT</span><span class="o">.</span><span class="n">lna</span><span class="p">[</span><span class="n">lna_idx</span><span class="p">]</span> <span class="c1"># Current scale factor</span>
        <span class="n">chi</span> <span class="o">=</span> <span class="n">k</span><span class="o">*</span><span class="p">(</span><span class="n">BG</span><span class="o">.</span><span class="n">tau0</span><span class="o">-</span><span class="n">BG</span><span class="o">.</span><span class="n">tau</span><span class="p">(</span><span class="n">lna</span><span class="p">))</span> <span class="c1"># Argument of phi0</span>
        <span class="n">aH</span> <span class="o">=</span> <span class="n">BG</span><span class="o">.</span><span class="n">aH</span><span class="p">(</span><span class="n">lna</span><span class="p">)</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">BG</span><span class="o">.</span><span class="n">visibility</span><span class="p">(</span><span class="n">lna</span><span class="p">)</span>

        <span class="c1"># Interpolate perturbation solutions</span>
        <span class="n">logk</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
        <span class="n">logk_axis</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">PT</span><span class="o">.</span><span class="n">k</span><span class="p">)</span>
        <span class="n">Fg2</span> <span class="o">=</span> <span class="n">tools</span><span class="o">.</span><span class="n">fast_interp</span><span class="p">(</span><span class="n">logk</span><span class="p">,</span> <span class="n">logk_axis</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">logk_axis</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">PT</span><span class="o">.</span><span class="n">Fg2</span><span class="p">[:,</span> <span class="n">lna_idx</span><span class="p">])</span>
        <span class="n">Gg0</span> <span class="o">=</span> <span class="n">tools</span><span class="o">.</span><span class="n">fast_interp</span><span class="p">(</span><span class="n">logk</span><span class="p">,</span> <span class="n">logk_axis</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">logk_axis</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">PT</span><span class="o">.</span><span class="n">Gg0</span><span class="p">[:,</span> <span class="n">lna_idx</span><span class="p">])</span>
        <span class="n">Gg2</span> <span class="o">=</span> <span class="n">tools</span><span class="o">.</span><span class="n">fast_interp</span><span class="p">(</span><span class="n">logk</span><span class="p">,</span> <span class="n">logk_axis</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">logk_axis</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">PT</span><span class="o">.</span><span class="n">Gg2</span><span class="p">[:,</span> <span class="n">lna_idx</span><span class="p">])</span>

        <span class="c1">### Source Function ###</span>
        <span class="n">sourceE</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">6.</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">switch_pol</span> <span class="o">*</span> <span class="n">g</span> <span class="o">*</span> <span class="p">(</span><span class="n">Fg2</span><span class="o">+</span><span class="n">Gg0</span><span class="o">+</span><span class="n">Gg2</span><span class="p">)</span> <span class="o">/</span> <span class="mf">8.</span>

        <span class="k">return</span> <span class="n">sourceE</span> <span class="o">*</span> <span class="n">epsilon</span><span class="p">(</span><span class="n">ell_idx</span><span class="p">,</span> <span class="n">chi</span><span class="p">)</span> <span class="o">/</span> <span class="n">aH</span></div>


<div class="viewcode-block" id="SpectrumSolver.stop_T0">
<a class="viewcode-back" href="../../ABCMB.html#ABCMB.spectrum.SpectrumSolver.stop_T0">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">stop_T0</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ell_idx</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">lna_idx</span><span class="p">,</span> <span class="n">PT</span><span class="p">,</span> <span class="n">BG</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="SpectrumSolver.stop_T1T2E">
<a class="viewcode-back" href="../../ABCMB.html#ABCMB.spectrum.SpectrumSolver.stop_T1T2E">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">stop_T1T2E</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ell_idx</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">lna_idx</span><span class="p">,</span> <span class="n">PT</span><span class="p">,</span> <span class="n">BG</span><span class="p">):</span>
        <span class="c1"># return jnp.where(</span>
        <span class="c1">#     bessel_l_tab[ell_idx] &lt;= 400,</span>
        <span class="c1">#     PT.lna[lna_idx] &lt; BG.lna_visibility_stop,</span>
        <span class="c1">#     True</span>
        <span class="c1"># )</span>
        <span class="k">return</span> <span class="n">PT</span><span class="o">.</span><span class="n">lna</span><span class="p">[</span><span class="n">lna_idx</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">BG</span><span class="o">.</span><span class="n">lna_visibility_stop</span></div>


<div class="viewcode-block" id="SpectrumSolver.ClTT_loop">
<a class="viewcode-back" href="../../ABCMB.html#ABCMB.spectrum.SpectrumSolver.ClTT_loop">[docs]</a>
    <span class="nd">@jit</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">ClTT_loop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ell</span><span class="p">,</span> <span class="n">PT</span><span class="p">,</span> <span class="n">BG</span><span class="p">):</span>
        <span class="c1">### OUTDATED FUNCTION ###</span>
        
        <span class="n">k_cut_small</span> <span class="o">=</span> <span class="n">ell</span><span class="o">/</span><span class="n">BG</span><span class="o">.</span><span class="n">rA_rec</span>
        <span class="n">k_cut_large</span> <span class="o">=</span> <span class="n">ell</span><span class="o">/</span><span class="n">BG</span><span class="o">.</span><span class="n">rA_rec</span> <span class="o">+</span> <span class="mf">0.15</span>
        <span class="c1">#deltak = 2.*jnp.pi/BG.tau0/10.</span>
        <span class="c1">#k_integral_axis = jnp.arange(k_cut_small, k_cut_large+deltak, deltak)</span>
        <span class="n">k_integral_axis</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">k_cut_small</span><span class="p">,</span> <span class="n">k_cut_large</span><span class="p">,</span> <span class="mi">3500</span><span class="p">)</span>
        <span class="n">vec_transfer_T0</span> <span class="o">=</span> <span class="n">eqx</span><span class="o">.</span><span class="n">filter_vmap</span><span class="p">(</span>
                <span class="n">partial</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">scalar_T0_transfer</span><span class="p">,</span>
                    <span class="n">ell</span><span class="o">=</span><span class="n">ell</span><span class="p">,</span>
                    <span class="n">PT</span><span class="o">=</span><span class="n">PT</span><span class="p">,</span>
                    <span class="n">BG</span><span class="o">=</span><span class="n">BG</span>
                <span class="p">),</span>
                <span class="n">in_axes</span><span class="o">=</span><span class="mi">0</span>  <span class="c1"># k will be vectorized over its first axis</span>
            <span class="p">)</span>
        <span class="n">vec_transfer_T1</span> <span class="o">=</span> <span class="n">eqx</span><span class="o">.</span><span class="n">filter_vmap</span><span class="p">(</span>
                <span class="n">partial</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">scalar_T1_transfer</span><span class="p">,</span>
                    <span class="n">ell</span><span class="o">=</span><span class="n">ell</span><span class="p">,</span>
                    <span class="n">PT</span><span class="o">=</span><span class="n">PT</span><span class="p">,</span>
                    <span class="n">BG</span><span class="o">=</span><span class="n">BG</span>
                <span class="p">),</span>
                <span class="n">in_axes</span><span class="o">=</span><span class="mi">0</span>  <span class="c1"># k will be vectorized over its first axis</span>
            <span class="p">)</span>
        <span class="n">transfer</span> <span class="o">=</span> <span class="n">vec_transfer_T0</span><span class="p">(</span><span class="n">k_integral_axis</span><span class="p">)</span> <span class="c1">#+ vec_transfer_T1(k_integral_axis)</span>
        <span class="n">integrand</span> <span class="o">=</span> <span class="mf">4.</span><span class="o">*</span><span class="n">jnp</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">BG</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;A_s&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">k_integral_axis</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">k_pivot</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="n">BG</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;n_s&#39;</span><span class="p">]</span><span class="o">-</span><span class="mf">1.</span><span class="p">)</span> <span class="o">*</span> <span class="n">transfer</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">k_integral_axis</span>
        <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">trapezoid</span><span class="p">(</span><span class="n">integrand</span><span class="p">,</span> <span class="n">k_integral_axis</span><span class="p">)</span></div>


<div class="viewcode-block" id="SpectrumSolver.scalar_T0_transfer">
<a class="viewcode-back" href="../../ABCMB.html#ABCMB.spectrum.SpectrumSolver.scalar_T0_transfer">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">scalar_T0_transfer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">ell</span><span class="p">,</span> <span class="n">PT</span><span class="p">,</span> <span class="n">BG</span><span class="p">):</span>
        <span class="c1">### OUTDATED FUNCTION ###</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes the scalar transfer function T0 for the temperature anisotropy. </span>
<span class="sd">        See Eqs.(3.1) &amp; (3.5) of https://iopscience.iop.org/article/10.1088/1475-7516/2014/09/032/pdf</span>

<span class="sd">        Params:</span>
<span class="sd">            k : float</span>
<span class="sd">            ell : float</span>
<span class="sd">            PT : perturbations.PerturbationTable</span>
<span class="sd">            BG  : cosmology.Background</span>
<span class="sd">            firstx : float</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tau0</span> <span class="o">=</span> <span class="n">BG</span><span class="o">.</span><span class="n">tau0</span>
        
        <span class="nd">@jax</span><span class="o">.</span><span class="n">named_scope</span><span class="p">(</span><span class="s2">&quot;integrand func&quot;</span><span class="p">)</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">integrand_func</span><span class="p">(</span><span class="n">lna</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            The integrand over lna for the T0 CMB transfer function.</span>
<span class="sd">            We use Eq.(3.9) of arXiv:1312.2697, but in the SYNCHRONOUS GAUGE.</span>
<span class="sd">            This was read off in the source code for CLASS, in perturbations_sources()</span>
<span class="sd">            &quot;&quot;&quot;</span>

            <span class="c1"># Background quantities</span>
            <span class="n">tau</span> <span class="o">=</span> <span class="n">BG</span><span class="o">.</span><span class="n">tau</span><span class="p">(</span><span class="n">lna</span><span class="p">)</span>
            <span class="n">g</span>   <span class="o">=</span> <span class="n">BG</span><span class="o">.</span><span class="n">visibility</span><span class="p">(</span><span class="n">lna</span><span class="p">)</span>
            <span class="n">g_prime</span> <span class="o">=</span> <span class="n">grad</span><span class="p">(</span><span class="n">BG</span><span class="o">.</span><span class="n">visibility</span><span class="p">)(</span><span class="n">lna</span><span class="p">)</span> <span class="c1"># Derivative of g w.r.t. lna</span>
            <span class="n">aH</span>  <span class="o">=</span> <span class="n">BG</span><span class="o">.</span><span class="n">aH</span><span class="p">(</span><span class="n">lna</span><span class="p">)</span>
            <span class="n">kappa</span> <span class="o">=</span> <span class="n">BG</span><span class="o">.</span><span class="n">kappa</span><span class="p">(</span><span class="n">lna</span><span class="p">)</span>
            <span class="n">chi</span> <span class="o">=</span> <span class="n">k</span><span class="o">*</span><span class="p">(</span><span class="n">tau0</span><span class="o">-</span><span class="n">tau</span><span class="p">)</span>
            <span class="n">aH_dot</span> <span class="o">=</span> <span class="n">BG</span><span class="o">.</span><span class="n">aH_prime</span><span class="p">(</span><span class="n">lna</span><span class="p">)</span> <span class="o">*</span> <span class="n">aH</span> <span class="c1"># Derivative of aH w.r.t. conformal time tau.</span>

            <span class="c1"># Pertubations</span>
            <span class="n">point</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">k</span><span class="p">,</span> <span class="n">lna</span><span class="p">])</span>
            <span class="n">delta_g</span> <span class="o">=</span> <span class="n">PT</span><span class="o">.</span><span class="n">delta_g</span><span class="p">(</span><span class="n">point</span><span class="p">)</span>
            <span class="n">theta_b</span> <span class="o">=</span> <span class="n">PT</span><span class="o">.</span><span class="n">theta_b</span><span class="p">(</span><span class="n">point</span><span class="p">)</span>
            <span class="n">theta_b_prime</span> <span class="o">=</span> <span class="n">PT</span><span class="o">.</span><span class="n">theta_b_prime</span><span class="p">(</span><span class="n">point</span><span class="p">)</span>
            <span class="n">alpha</span> <span class="o">=</span> <span class="n">PT</span><span class="o">.</span><span class="n">metric_alpha</span><span class="p">(</span><span class="n">point</span><span class="p">)</span>
            <span class="n">alpha_prime</span> <span class="o">=</span> <span class="n">PT</span><span class="o">.</span><span class="n">metric_alpha_prime</span><span class="p">(</span><span class="n">point</span><span class="p">)</span>
            <span class="n">h_prime</span> <span class="o">=</span> <span class="n">PT</span><span class="o">.</span><span class="n">metric_h_prime</span><span class="p">(</span><span class="n">point</span><span class="p">)</span>
            <span class="n">eta</span> <span class="o">=</span> <span class="n">PT</span><span class="o">.</span><span class="n">metric_eta</span><span class="p">(</span><span class="n">point</span><span class="p">)</span>
            <span class="n">eta_prime</span> <span class="o">=</span> <span class="n">PT</span><span class="o">.</span><span class="n">metric_eta_prime</span><span class="p">(</span><span class="n">point</span><span class="p">)</span>

            <span class="n">sourceT0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">switch_sw</span> <span class="o">*</span> <span class="n">g</span> <span class="o">*</span> <span class="p">(</span><span class="n">delta_g</span><span class="o">/</span><span class="mf">4.</span> <span class="o">+</span> <span class="n">aH</span><span class="o">*</span><span class="n">alpha_prime</span><span class="p">)</span> \
                     <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">switch_isw</span> <span class="o">*</span> <span class="p">(</span>
                        <span class="n">g</span> <span class="o">*</span> <span class="p">(</span> <span class="n">eta</span> <span class="o">-</span> <span class="n">aH</span><span class="o">*</span><span class="n">alpha_prime</span> <span class="o">-</span> <span class="mf">2.</span><span class="o">*</span><span class="n">aH</span><span class="o">*</span><span class="n">alpha</span> <span class="p">)</span> \
                        <span class="o">+</span> <span class="mf">2.</span><span class="o">*</span><span class="n">jnp</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">kappa</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span> <span class="n">aH</span><span class="o">*</span><span class="n">eta_prime</span> <span class="o">-</span> <span class="n">aH_dot</span><span class="o">*</span><span class="n">alpha</span> <span class="o">-</span> <span class="n">aH</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">alpha_prime</span> <span class="p">)</span>
                     <span class="p">)</span> \
                     <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">switch_dop</span> <span class="o">*</span> <span class="p">(</span>
                        <span class="n">aH</span><span class="o">/</span><span class="n">k</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">g</span><span class="o">*</span><span class="p">(</span><span class="n">theta_b_prime</span> <span class="o">+</span> <span class="n">alpha_prime</span><span class="o">*</span><span class="n">k</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">g_prime</span><span class="o">*</span><span class="p">(</span><span class="n">theta_b</span><span class="o">+</span><span class="n">alpha</span><span class="o">*</span><span class="n">k</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
                     <span class="p">)</span>
            <span class="n">integrand</span>  <span class="o">=</span>  <span class="n">sourceT0</span> <span class="o">/</span> <span class="n">aH</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">jl</span><span class="p">(</span><span class="n">ell</span><span class="p">,</span> <span class="n">chi</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">integrand</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">term</span> <span class="o">=</span> <span class="n">ODETerm</span><span class="p">(</span><span class="n">integrand_func</span><span class="p">)</span>
        <span class="n">controller</span> <span class="o">=</span> <span class="n">PIDController</span><span class="p">(</span><span class="n">rtol</span><span class="o">=</span><span class="mf">1.e-3</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1.e-6</span><span class="p">)</span> <span class="c1"># TODO: Try replacing with quadax, probably faster!</span>

        <span class="c1"># Translate to upper bound on lna, given x = k(tau_0 - tau)</span>
        <span class="n">lna_stop_vals</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">BG</span><span class="o">.</span><span class="n">lna_transfer_start</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
        <span class="n">chi_stop_vals</span> <span class="o">=</span> <span class="n">k</span><span class="o">*</span><span class="p">(</span><span class="n">tau0</span><span class="o">-</span><span class="n">BG</span><span class="o">.</span><span class="n">tau</span><span class="p">(</span><span class="n">lna_stop_vals</span><span class="p">))</span>
        <span class="n">lna_stop</span> <span class="o">=</span> <span class="n">lna_stop_vals</span><span class="p">[</span><span class="n">jnp</span><span class="o">.</span><span class="n">argmin</span><span class="p">((</span><span class="n">chi_stop_vals</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">jl_stop</span><span class="p">[</span><span class="n">ell</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)]</span>

        <span class="n">sol</span> <span class="o">=</span> <span class="n">diffeqsolve</span><span class="p">(</span>
            <span class="n">term</span><span class="p">,</span>
            <span class="n">solver</span><span class="o">=</span><span class="n">Kvaerno5</span><span class="p">(),</span>
            <span class="n">t0</span><span class="o">=</span><span class="n">BG</span><span class="o">.</span><span class="n">lna_transfer_start</span><span class="p">,</span>
            <span class="n">t1</span><span class="o">=</span><span class="n">lna_stop</span><span class="p">,</span>
            <span class="n">dt0</span><span class="o">=</span><span class="mf">1.e-2</span><span class="p">,</span>     
            <span class="n">y0</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span>
            <span class="n">stepsize_controller</span><span class="o">=</span><span class="n">controller</span><span class="p">,</span>
            <span class="n">max_steps</span> <span class="o">=</span> <span class="mi">10000</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">sol</span><span class="o">.</span><span class="n">ys</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></div>


<div class="viewcode-block" id="SpectrumSolver.scalar_T1_transfer">
<a class="viewcode-back" href="../../ABCMB.html#ABCMB.spectrum.SpectrumSolver.scalar_T1_transfer">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">scalar_T1_transfer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">ell</span><span class="p">,</span> <span class="n">PT</span><span class="p">,</span> <span class="n">BG</span><span class="p">):</span>
        <span class="c1">### OUTDATED FUNCTION ###</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes the scalar transfer function T1 for the temperature anisotropy. </span>
<span class="sd">        See Eqs.(3.1) &amp; (3.5) of https://iopscience.iop.org/article/10.1088/1475-7516/2014/09/032/pdf</span>

<span class="sd">        Params:</span>
<span class="sd">            k : float</span>
<span class="sd">            ell : float</span>
<span class="sd">            PT : perturbations.PerturbationTable</span>
<span class="sd">            BG  : cosmology.Background</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tau0</span> <span class="o">=</span> <span class="n">BG</span><span class="o">.</span><span class="n">tau0</span>
        
        <span class="k">def</span><span class="w"> </span><span class="nf">integrand_func</span><span class="p">(</span><span class="n">lna</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            The integrand over lna for the T1 CMB transfer function.</span>
<span class="sd">            We use Eq.(3.9) of arXiv:1312.2697, but in the SYNCHRONOUS GAUGE.</span>
<span class="sd">            This was read off in the source code for CLASS, in perturbations_sources()</span>
<span class="sd">            &quot;&quot;&quot;</span>

            <span class="c1"># Background quantities</span>
            <span class="n">tau</span> <span class="o">=</span> <span class="n">BG</span><span class="o">.</span><span class="n">tau</span><span class="p">(</span><span class="n">lna</span><span class="p">)</span>
            <span class="n">aH</span>  <span class="o">=</span> <span class="n">BG</span><span class="o">.</span><span class="n">aH</span><span class="p">(</span><span class="n">lna</span><span class="p">)</span>
            <span class="n">kappa</span> <span class="o">=</span> <span class="n">BG</span><span class="o">.</span><span class="n">kappa</span><span class="p">(</span><span class="n">lna</span><span class="p">)</span>
            <span class="n">chi</span> <span class="o">=</span> <span class="n">k</span><span class="o">*</span><span class="p">(</span><span class="n">tau0</span><span class="o">-</span><span class="n">tau</span><span class="p">)</span>

            <span class="c1"># Pertubations</span>
            <span class="n">point</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">k</span><span class="p">,</span> <span class="n">lna</span><span class="p">])</span>
            <span class="n">alpha</span> <span class="o">=</span> <span class="n">PT</span><span class="o">.</span><span class="n">metric_alpha</span><span class="p">(</span><span class="n">point</span><span class="p">)</span>
            <span class="n">alpha_prime</span> <span class="o">=</span> <span class="n">PT</span><span class="o">.</span><span class="n">metric_alpha_prime</span><span class="p">(</span><span class="n">point</span><span class="p">)</span>
            <span class="n">eta</span> <span class="o">=</span> <span class="n">PT</span><span class="o">.</span><span class="n">metric_eta</span><span class="p">(</span><span class="n">point</span><span class="p">)</span>

            <span class="n">sourceT1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">switch_isw</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">kappa</span><span class="p">)</span> <span class="o">*</span> <span class="n">k</span> <span class="o">*</span> <span class="p">(</span>
                <span class="n">aH</span><span class="o">*</span><span class="n">alpha_prime</span> <span class="o">+</span> <span class="mf">2.</span><span class="o">*</span><span class="n">aH</span><span class="o">*</span><span class="n">alpha</span> <span class="o">-</span> <span class="n">eta</span>
            <span class="p">)</span>

            <span class="n">integrand</span>  <span class="o">=</span>  <span class="n">sourceT1</span> <span class="o">/</span> <span class="n">aH</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">jl_prime</span><span class="p">(</span><span class="n">ell</span><span class="p">,</span> <span class="n">chi</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">integrand</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">term</span> <span class="o">=</span> <span class="n">ODETerm</span><span class="p">(</span><span class="n">integrand_func</span><span class="p">)</span>
        <span class="n">controller</span> <span class="o">=</span> <span class="n">PIDController</span><span class="p">(</span><span class="n">rtol</span><span class="o">=</span><span class="mf">1.e-3</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1.e-6</span><span class="p">)</span>

        <span class="c1"># Translate to upper bound on lna, given x = k(tau_0 - tau)</span>
        <span class="n">lna_stop_vals</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">BG</span><span class="o">.</span><span class="n">lna_transfer_start</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
        <span class="n">chi_stop_vals</span> <span class="o">=</span> <span class="n">k</span><span class="o">*</span><span class="p">(</span><span class="n">tau0</span><span class="o">-</span><span class="n">BG</span><span class="o">.</span><span class="n">tau</span><span class="p">(</span><span class="n">lna_stop_vals</span><span class="p">))</span>
        <span class="n">lna_stop</span> <span class="o">=</span> <span class="n">lna_stop_vals</span><span class="p">[</span><span class="n">jnp</span><span class="o">.</span><span class="n">argmin</span><span class="p">((</span><span class="n">chi_stop_vals</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">jl_stop</span><span class="p">[</span><span class="n">ell</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)]</span>

        <span class="n">sol</span> <span class="o">=</span> <span class="n">diffeqsolve</span><span class="p">(</span>
            <span class="n">term</span><span class="p">,</span>
            <span class="n">solver</span><span class="o">=</span><span class="n">Kvaerno5</span><span class="p">(),</span>
            <span class="n">t0</span><span class="o">=</span><span class="n">BG</span><span class="o">.</span><span class="n">lna_transfer_start</span><span class="p">,</span>
            <span class="n">t1</span><span class="o">=</span><span class="n">lna_stop</span><span class="p">,</span>
            <span class="n">dt0</span><span class="o">=</span><span class="mf">1.e-2</span><span class="p">,</span>     
            <span class="n">y0</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span>
            <span class="n">stepsize_controller</span><span class="o">=</span><span class="n">controller</span><span class="p">,</span>
            <span class="n">max_steps</span> <span class="o">=</span> <span class="mi">10000</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">sol</span><span class="o">.</span><span class="n">ys</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></div>


<div class="viewcode-block" id="SpectrumSolver.scalar_T2_transfer">
<a class="viewcode-back" href="../../ABCMB.html#ABCMB.spectrum.SpectrumSolver.scalar_T2_transfer">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">scalar_T2_transfer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">ell</span><span class="p">,</span> <span class="n">PT</span><span class="p">,</span> <span class="n">BG</span><span class="p">):</span>
        <span class="c1">### OUTDATED FUNCTION ###</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes the scalar transfer function T2 for the temperature anisotropy. </span>
<span class="sd">        See Eqs.(3.1) &amp; (3.5) of https://iopscience.iop.org/article/10.1088/1475-7516/2014/09/032/pdf</span>

<span class="sd">        Params:</span>
<span class="sd">            k : float</span>
<span class="sd">            ell : float</span>
<span class="sd">            PT : perturbations.PerturbationTable</span>
<span class="sd">            BG  : cosmology.Background</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tau0</span> <span class="o">=</span> <span class="n">BG</span><span class="o">.</span><span class="n">tau0</span>
        
        <span class="k">def</span><span class="w"> </span><span class="nf">integrand_func</span><span class="p">(</span><span class="n">lna</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            The integrand over lna for the T1 CMB transfer function.</span>
<span class="sd">            We use Eq.(3.9) of arXiv:1312.2697, but in the SYNCHRONOUS GAUGE.</span>
<span class="sd">            This was read off in the source code for CLASS, in perturbations_sources()</span>
<span class="sd">            &quot;&quot;&quot;</span>

            <span class="c1"># Background quantities</span>
            <span class="n">tau</span> <span class="o">=</span> <span class="n">BG</span><span class="o">.</span><span class="n">tau</span><span class="p">(</span><span class="n">lna</span><span class="p">)</span>
            <span class="n">aH</span>  <span class="o">=</span> <span class="n">BG</span><span class="o">.</span><span class="n">aH</span><span class="p">(</span><span class="n">lna</span><span class="p">)</span>
            <span class="n">kappa</span> <span class="o">=</span> <span class="n">BG</span><span class="o">.</span><span class="n">kappa</span><span class="p">(</span><span class="n">lna</span><span class="p">)</span>
            <span class="n">chi</span> <span class="o">=</span> <span class="n">k</span><span class="o">*</span><span class="p">(</span><span class="n">tau0</span><span class="o">-</span><span class="n">tau</span><span class="p">)</span>

            <span class="c1"># Pertubations</span>
            <span class="n">point</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">k</span><span class="p">,</span> <span class="n">lna</span><span class="p">])</span>
            <span class="n">alpha</span> <span class="o">=</span> <span class="n">PT</span><span class="o">.</span><span class="n">metric_alpha</span><span class="p">(</span><span class="n">point</span><span class="p">)</span>
            <span class="n">alpha_prime</span> <span class="o">=</span> <span class="n">PT</span><span class="o">.</span><span class="n">metric_alpha_prime</span><span class="p">(</span><span class="n">point</span><span class="p">)</span>
            <span class="n">eta</span> <span class="o">=</span> <span class="n">PT</span><span class="o">.</span><span class="n">metric_eta</span><span class="p">(</span><span class="n">point</span><span class="p">)</span>

            <span class="n">sourceT1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">switch_isw</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">kappa</span><span class="p">)</span> <span class="o">*</span> <span class="n">k</span> <span class="o">*</span> <span class="p">(</span>
                <span class="n">aH</span><span class="o">*</span><span class="n">alpha_prime</span> <span class="o">+</span> <span class="mf">2.</span><span class="o">*</span><span class="n">aH</span><span class="o">*</span><span class="n">alpha</span> <span class="o">-</span> <span class="n">eta</span>
            <span class="p">)</span>

            <span class="n">integrand</span>  <span class="o">=</span>  <span class="n">sourceT1</span> <span class="o">/</span> <span class="n">aH</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">jl_prime</span><span class="p">(</span><span class="n">ell</span><span class="p">,</span> <span class="n">chi</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">integrand</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">term</span> <span class="o">=</span> <span class="n">ODETerm</span><span class="p">(</span><span class="n">integrand_func</span><span class="p">)</span>
        <span class="n">controller</span> <span class="o">=</span> <span class="n">PIDController</span><span class="p">(</span><span class="n">rtol</span><span class="o">=</span><span class="mf">1.e-3</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1.e-6</span><span class="p">)</span>

        <span class="c1"># Translate to upper bound on lna, given x = k(tau_0 - tau)</span>
        <span class="n">lna_stop_vals</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">BG</span><span class="o">.</span><span class="n">lna_transfer_start</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
        <span class="n">chi_stop_vals</span> <span class="o">=</span> <span class="n">k</span><span class="o">*</span><span class="p">(</span><span class="n">tau0</span><span class="o">-</span><span class="n">BG</span><span class="o">.</span><span class="n">tau</span><span class="p">(</span><span class="n">lna_stop_vals</span><span class="p">))</span>
        <span class="n">lna_stop</span> <span class="o">=</span> <span class="n">lna_stop_vals</span><span class="p">[</span><span class="n">jnp</span><span class="o">.</span><span class="n">argmin</span><span class="p">((</span><span class="n">chi_stop_vals</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">jl_stop</span><span class="p">[</span><span class="n">ell</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)]</span>

        <span class="n">sol</span> <span class="o">=</span> <span class="n">diffeqsolve</span><span class="p">(</span>
            <span class="n">term</span><span class="p">,</span>
            <span class="n">solver</span><span class="o">=</span><span class="n">Kvaerno5</span><span class="p">(),</span>
            <span class="n">t0</span><span class="o">=</span><span class="n">BG</span><span class="o">.</span><span class="n">lna_transfer_start</span><span class="p">,</span>
            <span class="n">t1</span><span class="o">=</span><span class="n">lna_stop</span><span class="p">,</span>
            <span class="n">dt0</span><span class="o">=</span><span class="mf">1.e-2</span><span class="p">,</span>     
            <span class="n">y0</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span>
            <span class="n">stepsize_controller</span><span class="o">=</span><span class="n">controller</span><span class="p">,</span>
            <span class="n">max_steps</span> <span class="o">=</span> <span class="mi">10000</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">sol</span><span class="o">.</span><span class="n">ys</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></div>


<div class="viewcode-block" id="SpectrumSolver.ClTT_diffrax">
<a class="viewcode-back" href="../../ABCMB.html#ABCMB.spectrum.SpectrumSolver.ClTT_diffrax">[docs]</a>
    <span class="nd">@jit</span>
    <span class="nd">@jax</span><span class="o">.</span><span class="n">named_scope</span><span class="p">(</span><span class="s2">&quot;ClTT diffrax&quot;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">ClTT_diffrax</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ell</span><span class="p">,</span> <span class="n">PT</span><span class="p">,</span> <span class="n">BG</span><span class="p">):</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">integrand_func</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
            <span class="n">transfer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scalar_T0_transfer</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">ell</span><span class="p">,</span> <span class="n">PT</span><span class="p">,</span> <span class="n">BG</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">scalar_T1_transfer</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">ell</span><span class="p">,</span> <span class="n">PT</span><span class="p">,</span> <span class="n">BG</span><span class="p">)</span>
            <span class="n">integrand</span> <span class="o">=</span> <span class="mf">4.</span><span class="o">*</span><span class="n">jnp</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">BG</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;A_s&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">k</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">k_pivot</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="n">BG</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;n_s&#39;</span><span class="p">]</span><span class="o">-</span><span class="mf">1.</span><span class="p">)</span> <span class="o">*</span> <span class="n">transfer</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">k</span>
            <span class="k">return</span> <span class="n">integrand</span>
        
        <span class="n">term</span> <span class="o">=</span> <span class="n">ODETerm</span><span class="p">(</span><span class="n">integrand_func</span><span class="p">)</span>
        <span class="n">controller</span> <span class="o">=</span> <span class="n">PIDController</span><span class="p">(</span><span class="n">rtol</span><span class="o">=</span><span class="mf">1.e-2</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1.e-2</span><span class="p">)</span>

        <span class="n">sol</span> <span class="o">=</span> <span class="n">diffeqsolve</span><span class="p">(</span>
            <span class="n">term</span><span class="p">,</span>
            <span class="n">solver</span><span class="o">=</span><span class="n">Kvaerno5</span><span class="p">(),</span>
            <span class="n">t0</span><span class="o">=</span><span class="mf">5.e-3</span><span class="p">,</span>
            <span class="n">t1</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
            <span class="n">dt0</span><span class="o">=</span><span class="mf">1.e-3</span><span class="p">,</span>     
            <span class="n">y0</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span>
            <span class="n">stepsize_controller</span><span class="o">=</span><span class="n">controller</span><span class="p">,</span>
            <span class="n">max_steps</span> <span class="o">=</span> <span class="mi">30000</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">sol</span><span class="o">.</span><span class="n">ys</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></div>


    <span class="c1">#@jit</span>
<div class="viewcode-block" id="SpectrumSolver.ClEE">
<a class="viewcode-back" href="../../ABCMB.html#ABCMB.spectrum.SpectrumSolver.ClEE">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">ClEE</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ell</span><span class="p">,</span> <span class="n">k_axis</span><span class="p">,</span> <span class="n">lna_axis</span><span class="p">,</span> <span class="n">Fg2</span><span class="p">,</span> <span class="n">Gg0</span><span class="p">,</span> <span class="n">Gg2</span><span class="p">,</span> <span class="n">BG</span><span class="p">,</span> <span class="n">A_s</span><span class="p">,</span> <span class="n">n_s</span><span class="p">):</span>
        
        <span class="n">Fg2_interp_func</span> <span class="o">=</span> <span class="n">RegularGridInterpolator</span><span class="p">((</span><span class="n">k_axis</span><span class="p">,</span> <span class="n">lna_axis</span><span class="p">),</span> <span class="n">Fg2</span><span class="p">)</span>
        <span class="n">Gg0_interp_func</span> <span class="o">=</span> <span class="n">RegularGridInterpolator</span><span class="p">((</span><span class="n">k_axis</span><span class="p">,</span> <span class="n">lna_axis</span><span class="p">),</span> <span class="n">Gg0</span><span class="p">)</span>
        <span class="n">Gg2_interp_func</span> <span class="o">=</span> <span class="n">RegularGridInterpolator</span><span class="p">((</span><span class="n">k_axis</span><span class="p">,</span> <span class="n">lna_axis</span><span class="p">),</span> <span class="n">Gg2</span><span class="p">)</span>

        <span class="c1">#k_integral_axis = jnp.linspace(k_axis[0], k_axis[-1], 5000)</span>
        <span class="n">k_integral_axis</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.9</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span><span class="o">*</span><span class="n">ell</span><span class="o">/</span><span class="n">BG</span><span class="o">.</span><span class="n">tau0</span> <span class="c1"># Callin 2006 convention</span>
        <span class="n">vec_source</span> <span class="o">=</span> <span class="n">eqx</span><span class="o">.</span><span class="n">filter_vmap</span><span class="p">(</span>
                <span class="n">partial</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">scalar_E_source</span><span class="p">,</span>
                    <span class="n">ell</span><span class="o">=</span><span class="n">ell</span><span class="p">,</span>
                    <span class="n">lna_axis</span><span class="o">=</span><span class="n">lna_axis</span><span class="p">,</span>
                    <span class="n">Fg2_func</span><span class="o">=</span><span class="n">Fg2_interp_func</span><span class="p">,</span>
                    <span class="n">Gg0_func</span><span class="o">=</span><span class="n">Gg0_interp_func</span><span class="p">,</span>
                    <span class="n">Gg2_func</span><span class="o">=</span><span class="n">Gg2_interp_func</span><span class="p">,</span>
                    <span class="n">BG</span><span class="o">=</span><span class="n">BG</span>
                <span class="p">),</span>
                <span class="n">in_axes</span><span class="o">=</span><span class="mi">0</span>  <span class="c1"># k will be vectorized over its first axis</span>
            <span class="p">)</span>
        <span class="n">sources</span> <span class="o">=</span> <span class="n">vec_source</span><span class="p">(</span><span class="n">k_integral_axis</span><span class="p">)</span>
        <span class="n">integrand</span> <span class="o">=</span> <span class="mf">4.</span><span class="o">*</span><span class="n">jnp</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">A_s</span> <span class="o">*</span> <span class="p">(</span><span class="n">k_integral_axis</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">k_pivot</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="n">n_s</span><span class="o">-</span><span class="mf">1.</span><span class="p">)</span> <span class="o">*</span> <span class="n">sources</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">k_integral_axis</span>
        <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">trapezoid</span><span class="p">(</span><span class="n">integrand</span><span class="p">,</span> <span class="n">k_integral_axis</span><span class="p">)</span></div>


        <span class="c1"># def integrand_func(k, y, args):</span>
        <span class="c1">#     E_source = self.scalar_E_source(ell, k, lna_axis, Fg2_interp_func, Gg0_interp_func, Gg2_interp_func, BG)</span>
        <span class="c1">#     PR = A_s #* (k/self.k_pivot)**(n_s-1.)</span>
        <span class="c1">#     return E_source**2 * PR / k</span>

        <span class="c1"># term = ODETerm(integrand_func)</span>
        <span class="c1"># controller = PIDController(rtol=1.e-3, atol=1.e-6)</span>
        <span class="c1"># sol = diffeqsolve(</span>
        <span class="c1">#     term,</span>
        <span class="c1">#     solver=Kvaerno5(),</span>
        <span class="c1">#     t0=k_axis[1],</span>
        <span class="c1">#     t1=k_axis[-1],</span>
        <span class="c1">#     dt0=1.e-4,     </span>
        <span class="c1">#     y0=0.,</span>
        <span class="c1">#     stepsize_controller=controller,  # Use the PID step size controller</span>
        <span class="c1">#     max_steps = 10000</span>
        <span class="c1"># )</span>
        <span class="c1"># return 4.*jnp.pi*sol.ys[0]</span>

<div class="viewcode-block" id="SpectrumSolver.scalar_E_source">
<a class="viewcode-back" href="../../ABCMB.html#ABCMB.spectrum.SpectrumSolver.scalar_E_source">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">scalar_E_source</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">ell</span><span class="p">,</span> <span class="n">lna_axis</span><span class="p">,</span> <span class="n">Fg2_func</span><span class="p">,</span> <span class="n">Gg0_func</span><span class="p">,</span> <span class="n">Gg2_func</span><span class="p">,</span> <span class="n">BG</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes the scalar source function for E-mode polarization. </span>
<span class="sd">        See Eq.(3.2) of https://iopscience.iop.org/article/10.1088/1475-7516/2014/09/032/pdf</span>

<span class="sd">        Params:</span>
<span class="sd">            k : float</span>
<span class="sd">            ell : float</span>
<span class="sd">            lna_axis : jnp.array</span>
<span class="sd">            Fg2 : jnp.array (same shape as lna_axis)</span>
<span class="sd">            Gg0 : jnp.array (same shape as lna_axis)</span>
<span class="sd">            Gg2 : jnp.array (same shape as lna_axis)</span>
<span class="sd">            BG  : cosmology.Background</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">N</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">6.</span><span class="p">)</span><span class="o">/</span><span class="mf">8.</span><span class="o">*</span><span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">3.</span><span class="o">/</span><span class="mf">8.</span> <span class="o">*</span> <span class="p">(</span><span class="n">ell</span><span class="o">+</span><span class="mf">2.</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">ell</span><span class="o">+</span><span class="mf">1.</span><span class="p">)</span> <span class="o">*</span> <span class="n">ell</span> <span class="o">*</span> <span class="p">(</span><span class="n">ell</span><span class="o">-</span><span class="mf">1.</span><span class="p">))</span>
        <span class="n">tau0</span> <span class="o">=</span> <span class="n">BG</span><span class="o">.</span><span class="n">tau0</span>
        
        <span class="k">def</span><span class="w"> </span><span class="nf">integrand_func</span><span class="p">(</span><span class="n">lna</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
            <span class="n">tau</span> <span class="o">=</span> <span class="n">BG</span><span class="o">.</span><span class="n">tau</span><span class="p">(</span><span class="n">lna</span><span class="p">)</span>
            <span class="n">g</span>   <span class="o">=</span> <span class="n">BG</span><span class="o">.</span><span class="n">visibility</span><span class="p">(</span><span class="n">lna</span><span class="p">)</span>
            <span class="n">aH</span>  <span class="o">=</span> <span class="n">BG</span><span class="o">.</span><span class="n">aH</span><span class="p">(</span><span class="n">lna</span><span class="p">)</span>
            <span class="n">chi</span> <span class="o">=</span> <span class="n">k</span><span class="o">*</span><span class="p">(</span><span class="n">tau0</span><span class="o">-</span><span class="n">tau</span><span class="p">)</span>
            <span class="n">Fg2</span> <span class="o">=</span> <span class="n">Fg2_func</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">k</span><span class="p">,</span> <span class="n">lna</span><span class="p">]))</span>
            <span class="n">Gg0</span> <span class="o">=</span> <span class="n">Fg2_func</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">k</span><span class="p">,</span> <span class="n">lna</span><span class="p">]))</span>
            <span class="n">Gg2</span> <span class="o">=</span> <span class="n">Fg2_func</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">k</span><span class="p">,</span> <span class="n">lna</span><span class="p">]))</span>
            <span class="n">integrand</span>  <span class="o">=</span> <span class="n">g</span><span class="o">/</span><span class="n">aH</span> <span class="o">*</span> <span class="p">(</span><span class="n">Fg2</span><span class="o">+</span><span class="n">Gg0</span><span class="o">+</span><span class="n">Gg2</span><span class="p">)</span> <span class="o">*</span> <span class="n">jl</span><span class="p">(</span><span class="n">ell</span><span class="p">,</span> <span class="n">chi</span><span class="p">,</span> <span class="mf">1.e-14</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="c1">#/ chi**2</span>
            <span class="k">return</span> <span class="n">integrand</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">stop_func</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Stops the solver when tau becomes late enough that we approach the x=0 part of the Bessel function.</span>
<span class="sd">            This part of the integrand is zero, and stopping before avoids a numerical divergence.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">lna</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">tprev</span>
            <span class="n">tau</span> <span class="o">=</span> <span class="n">BG</span><span class="o">.</span><span class="n">tau</span><span class="p">(</span><span class="n">lna</span><span class="p">)</span>
            <span class="n">chi</span> <span class="o">=</span> <span class="n">k</span><span class="o">*</span><span class="p">(</span><span class="n">tau0</span><span class="o">-</span><span class="n">tau</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">chi</span> <span class="o">&lt;</span> <span class="n">ell</span><span class="o">/</span><span class="mf">2.</span>

        <span class="n">term</span> <span class="o">=</span> <span class="n">ODETerm</span><span class="p">(</span><span class="n">integrand_func</span><span class="p">)</span>
        <span class="n">controller</span> <span class="o">=</span> <span class="n">PIDController</span><span class="p">(</span><span class="n">rtol</span><span class="o">=</span><span class="mf">1.e-2</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1.e-2</span><span class="p">)</span>

        <span class="n">sol</span> <span class="o">=</span> <span class="n">diffeqsolve</span><span class="p">(</span>
            <span class="n">term</span><span class="p">,</span>
            <span class="n">solver</span><span class="o">=</span><span class="n">Kvaerno5</span><span class="p">(),</span>
            <span class="n">t0</span><span class="o">=</span><span class="n">lna_axis</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">t1</span><span class="o">=</span><span class="n">lna_axis</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">dt0</span><span class="o">=</span><span class="mf">1.e-4</span><span class="p">,</span>     
            <span class="n">y0</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span>
            <span class="n">stepsize_controller</span><span class="o">=</span><span class="n">controller</span><span class="p">,</span>  <span class="c1"># Use the PID step size controller</span>
            <span class="n">max_steps</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">,</span>
            <span class="n">discrete_terminating_event</span> <span class="o">=</span> <span class="n">DiscreteTerminatingEvent</span><span class="p">(</span><span class="n">stop_func</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">N</span><span class="o">*</span><span class="n">sol</span><span class="o">.</span><span class="n">ys</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></div>
</div>

</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">ABCMB</a></h1>









<search id="searchbox" style="display: none" role="search">
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" placeholder="Search"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script><h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../getting-started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">ABCMB</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2025, Zilu Zhou, Cara Giovanetti, and Hongwan Liu.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 8.2.3</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 1.0.0</a>
      
    </div>

    

    
  </body>
</html>